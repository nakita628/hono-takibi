openapi: 3.1.0
info:
  title: Social Network API - Posts & Timeline
  version: 1.0.0
  description: |
    Twitter/X風SNSクローンのための投稿・タイムラインAPI。
    投稿（ポスト）の作成、タイムライン取得、リポスト、引用、返信などの機能を提供します。

servers:
  - url: https://api.social.example.com/v1
    description: Production
  - url: http://localhost:3000/v1
    description: Development

tags:
  - name: Posts
    description: 投稿操作
  - name: Timeline
    description: タイムライン
  - name: Interactions
    description: いいね・リポスト・ブックマーク
  - name: Replies
    description: 返信
  - name: Media
    description: メディアアップロード

paths:
  /posts:
    get:
      tags:
        - Posts
      operationId: listPosts
      summary: 投稿一覧取得
      description: 公開投稿の一覧を取得（検索・フィルタ用）
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: userId
          in: query
          description: 特定ユーザーの投稿のみ
          schema:
            type: string
            format: uuid
        - name: hashtag
          in: query
          description: ハッシュタグでフィルタ
          schema:
            type: string
        - name: mediaOnly
          in: query
          description: メディア付き投稿のみ
          schema:
            type: boolean
      responses:
        '200':
          description: 投稿一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostListResponse'

    post:
      tags:
        - Posts
      operationId: createPost
      summary: 投稿作成
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePostRequest'
      responses:
        '201':
          description: 投稿成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /posts/{postId}:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    get:
      tags:
        - Posts
      operationId: getPost
      summary: 投稿詳細取得
      responses:
        '200':
          description: 投稿詳細
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags:
        - Posts
      operationId: deletePost
      summary: 投稿削除
      security:
        - bearerAuth: []
      responses:
        '204':
          description: 削除成功
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /posts/{postId}/thread:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    get:
      tags:
        - Posts
      operationId: getPostThread
      summary: スレッド取得
      description: 投稿とその返信スレッドを取得
      responses:
        '200':
          description: スレッド
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostThread'
        '404':
          $ref: '#/components/responses/NotFound'

  /posts/{postId}/context:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    get:
      tags:
        - Posts
      operationId: getPostContext
      summary: 投稿コンテキスト取得
      description: 親投稿と返信を含むコンテキストを取得
      responses:
        '200':
          description: コンテキスト
          content:
            application/json:
              schema:
                type: object
                properties:
                  ancestors:
                    type: array
                    items:
                      $ref: '#/components/schemas/Post'
                    description: 親投稿のチェーン
                  post:
                    $ref: '#/components/schemas/Post'
                  descendants:
                    type: array
                    items:
                      $ref: '#/components/schemas/Post'
                    description: 返信

  /timeline/home:
    get:
      tags:
        - Timeline
      operationId: getHomeTimeline
      summary: ホームタイムライン取得
      description: フォローしているユーザーの投稿を時系列で取得
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: includeReplies
          in: query
          description: 返信を含める
          schema:
            type: boolean
            default: false
        - name: includeReposts
          in: query
          description: リポストを含める
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: タイムライン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimelineResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /timeline/for-you:
    get:
      tags:
        - Timeline
      operationId: getForYouTimeline
      summary: おすすめタイムライン取得
      description: アルゴリズムによるおすすめ投稿
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: おすすめタイムライン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimelineResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /timeline/user/{userId}:
    parameters:
      - name: userId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Timeline
      operationId: getUserTimeline
      summary: ユーザータイムライン取得
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: includeReplies
          in: query
          schema:
            type: boolean
            default: false
        - name: includeReposts
          in: query
          schema:
            type: boolean
            default: true
        - name: mediaOnly
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: ユーザータイムライン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimelineResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /timeline/hashtag/{hashtag}:
    parameters:
      - name: hashtag
        in: path
        required: true
        schema:
          type: string
    get:
      tags:
        - Timeline
      operationId: getHashtagTimeline
      summary: ハッシュタグタイムライン取得
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: ハッシュタグタイムライン
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimelineResponse'

  /posts/{postId}/like:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    post:
      tags:
        - Interactions
      operationId: likePost
      summary: いいね
      security:
        - bearerAuth: []
      responses:
        '200':
          description: いいね成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      tags:
        - Interactions
      operationId: unlikePost
      summary: いいね解除
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 解除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /posts/{postId}/repost:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    post:
      tags:
        - Interactions
      operationId: repost
      summary: リポスト
      security:
        - bearerAuth: []
      responses:
        '200':
          description: リポスト成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      tags:
        - Interactions
      operationId: unrepost
      summary: リポスト解除
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 解除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /posts/{postId}/quote:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    post:
      tags:
        - Interactions
      operationId: quotePost
      summary: 引用投稿
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - text
              properties:
                text:
                  type: string
                  minLength: 1
                  maxLength: 280
                mediaIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  maxItems: 4
      responses:
        '201':
          description: 引用投稿成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /posts/{postId}/bookmark:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    post:
      tags:
        - Interactions
      operationId: bookmarkPost
      summary: ブックマーク追加
      security:
        - bearerAuth: []
      responses:
        '200':
          description: ブックマーク成功
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      tags:
        - Interactions
      operationId: unbookmarkPost
      summary: ブックマーク解除
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 解除成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /bookmarks:
    get:
      tags:
        - Interactions
      operationId: listBookmarks
      summary: ブックマーク一覧取得
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: ブックマーク一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /posts/{postId}/likes:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    get:
      tags:
        - Interactions
      operationId: getPostLikes
      summary: いいねしたユーザー一覧
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: ユーザー一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'

  /posts/{postId}/reposts:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    get:
      tags:
        - Interactions
      operationId: getPostReposts
      summary: リポストしたユーザー一覧
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: ユーザー一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'

  /posts/{postId}/quotes:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    get:
      tags:
        - Interactions
      operationId: getPostQuotes
      summary: 引用投稿一覧
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: 引用投稿一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostListResponse'

  /posts/{postId}/replies:
    parameters:
      - $ref: '#/components/parameters/PostIdParam'
    get:
      tags:
        - Replies
      operationId: getPostReplies
      summary: 返信一覧取得
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: sort
          in: query
          schema:
            type: string
            enum:
              - recent
              - popular
              - relevant
            default: relevant
      responses:
        '200':
          description: 返信一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostListResponse'
    post:
      tags:
        - Replies
      operationId: replyToPost
      summary: 返信投稿
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePostRequest'
      responses:
        '201':
          description: 返信成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /media/upload:
    post:
      tags:
        - Media
      operationId: uploadMedia
      summary: メディアアップロード
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                alt:
                  type: string
                  maxLength: 1000
                  description: 代替テキスト
      responses:
        '201':
          description: アップロード成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Media'
        '400':
          description: ファイル形式エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '413':
          description: ファイルサイズ超過

  /media/{mediaId}:
    parameters:
      - name: mediaId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Media
      operationId: getMedia
      summary: メディア情報取得
      responses:
        '200':
          description: メディア情報
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Media'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags:
        - Media
      operationId: updateMedia
      summary: メディア情報更新
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                alt:
                  type: string
                  maxLength: 1000
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Media'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    PostIdParam:
      name: postId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    CursorParam:
      name: cursor
      in: query
      description: ページネーションカーソル
      schema:
        type: string

    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    Post:
      type: object
      required:
        - id
        - author
        - text
        - createdAt
        - metrics
      properties:
        id:
          type: string
          format: uuid
        author:
          $ref: '#/components/schemas/UserSummary'
        text:
          type: string
          maxLength: 280
        media:
          type: array
          items:
            $ref: '#/components/schemas/Media'
          maxItems: 4
        poll:
          $ref: '#/components/schemas/Poll'
        quotedPost:
          $ref: '#/components/schemas/Post'
          description: 引用元投稿
        replyTo:
          type: object
          description: 返信先情報
          properties:
            postId:
              type: string
              format: uuid
            author:
              $ref: '#/components/schemas/UserSummary'
        repostOf:
          $ref: '#/components/schemas/Post'
          description: リポスト元（リポストの場合）
        hashtags:
          type: array
          items:
            type: string
        mentions:
          type: array
          items:
            $ref: '#/components/schemas/UserSummary'
        urls:
          type: array
          items:
            $ref: '#/components/schemas/UrlEntity'
        card:
          $ref: '#/components/schemas/LinkCard'
          description: リンクカード
        visibility:
          type: string
          enum:
            - public
            - followers
            - mentioned
          default: public
        replySettings:
          type: string
          enum:
            - everyone
            - followers
            - mentioned
          default: everyone
        metrics:
          type: object
          required:
            - likeCount
            - repostCount
            - replyCount
            - quoteCount
            - viewCount
          properties:
            likeCount:
              type: integer
            repostCount:
              type: integer
            replyCount:
              type: integer
            quoteCount:
              type: integer
            viewCount:
              type: integer
            bookmarkCount:
              type: integer
        viewer:
          type: object
          description: 閲覧者のアクション状態
          properties:
            liked:
              type: boolean
            reposted:
              type: boolean
            bookmarked:
              type: boolean
        language:
          type: string
          description: 言語コード
        source:
          type: string
          description: 投稿元クライアント
        createdAt:
          type: string
          format: date-time
        editedAt:
          type: string
          format: date-time
        editHistory:
          type: array
          items:
            type: object
            properties:
              text:
                type: string
              editedAt:
                type: string
                format: date-time

    CreatePostRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          minLength: 1
          maxLength: 280
        mediaIds:
          type: array
          items:
            type: string
            format: uuid
          maxItems: 4
        poll:
          type: object
          required:
            - options
            - duration
          properties:
            options:
              type: array
              minItems: 2
              maxItems: 4
              items:
                type: string
                maxLength: 25
            duration:
              type: integer
              description: 投票期間（分）
              minimum: 5
              maximum: 10080
        visibility:
          type: string
          enum:
            - public
            - followers
            - mentioned
          default: public
        replySettings:
          type: string
          enum:
            - everyone
            - followers
            - mentioned
          default: everyone
        quotedPostId:
          type: string
          format: uuid

    UserSummary:
      type: object
      required:
        - id
        - username
        - displayName
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string
        displayName:
          type: string
        avatarUrl:
          type: string
          format: uri
        isVerified:
          type: boolean
        isFollowing:
          type: boolean
        isFollowedBy:
          type: boolean

    Media:
      type: object
      required:
        - id
        - type
        - url
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum:
            - image
            - gif
            - video
        url:
          type: string
          format: uri
        previewUrl:
          type: string
          format: uri
        alt:
          type: string
        width:
          type: integer
        height:
          type: integer
        duration:
          type: number
          description: 動画の長さ（秒）
        blurhash:
          type: string
          description: プレースホルダー用ハッシュ

    Poll:
      type: object
      required:
        - id
        - options
        - expiresAt
        - totalVotes
      properties:
        id:
          type: string
          format: uuid
        options:
          type: array
          items:
            type: object
            required:
              - id
              - text
              - voteCount
            properties:
              id:
                type: string
              text:
                type: string
              voteCount:
                type: integer
              percentage:
                type: number
        totalVotes:
          type: integer
        expiresAt:
          type: string
          format: date-time
        isExpired:
          type: boolean
        viewerVote:
          type: string
          description: 閲覧者が投票したオプションID

    UrlEntity:
      type: object
      required:
        - url
        - expandedUrl
        - displayUrl
      properties:
        url:
          type: string
          format: uri
          description: 短縮URL
        expandedUrl:
          type: string
          format: uri
          description: 展開URL
        displayUrl:
          type: string
          description: 表示用URL
        start:
          type: integer
          description: テキスト内の開始位置
        end:
          type: integer
          description: テキスト内の終了位置

    LinkCard:
      type: object
      required:
        - url
        - title
      properties:
        url:
          type: string
          format: uri
        title:
          type: string
        description:
          type: string
        image:
          type: string
          format: uri
        siteName:
          type: string
        type:
          type: string
          enum:
            - link
            - photo
            - video
            - rich

    PostThread:
      type: object
      required:
        - post
      properties:
        post:
          $ref: '#/components/schemas/Post'
        ancestors:
          type: array
          items:
            $ref: '#/components/schemas/Post'
        replies:
          type: array
          items:
            $ref: '#/components/schemas/PostThread'

    PostListResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Post'
        nextCursor:
          type: string
        previousCursor:
          type: string

    TimelineResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TimelineItem'
        nextCursor:
          type: string
        previousCursor:
          type: string

    TimelineItem:
      type: object
      required:
        - type
        - post
      properties:
        type:
          type: string
          enum:
            - post
            - repost
            - reply
            - quote
            - promoted
        post:
          $ref: '#/components/schemas/Post'
        repostedBy:
          $ref: '#/components/schemas/UserSummary'
          description: リポストの場合、リポストしたユーザー
        reason:
          type: string
          description: おすすめの理由など

    UserListResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/UserSummary'
        nextCursor:
          type: string

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string

  responses:
    BadRequest:
      description: リクエストが不正です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: 認証が必要です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: アクセス権限がありません
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: リソースが見つかりません
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
