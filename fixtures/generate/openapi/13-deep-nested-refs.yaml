openapi: 3.1.0
info:
  title: Deep Nested References API
  version: 1.0.0
  description: Tests deeply nested $ref chains and indirect references
paths:
  /organizations/{orgId}/departments/{deptId}/teams/{teamId}/members:
    get:
      operationId: getTeamMembers
      parameters:
        - $ref: '#/components/parameters/OrgIdPath'
        - $ref: '#/components/parameters/DeptIdPath'
        - $ref: '#/components/parameters/TeamIdPath'
      responses:
        '200':
          description: Team members
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TeamMember'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      operationId: addTeamMember
      parameters:
        - $ref: '#/components/parameters/OrgIdPath'
        - $ref: '#/components/parameters/DeptIdPath'
        - $ref: '#/components/parameters/TeamIdPath'
      requestBody:
        $ref: '#/components/requestBodies/AddTeamMember'
      responses:
        '201':
          description: Member added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamMember'

  /reports/organization-summary:
    get:
      operationId: getOrganizationSummary
      responses:
        '200':
          description: Full organization summary with deep nesting
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationSummary'

components:
  schemas:
    # Level 1: Organization
    Organization:
      type: object
      required:
        - id
        - name
        - departments
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        metadata:
          $ref: '#/components/schemas/EntityMetadata'
        departments:
          type: array
          items:
            $ref: '#/components/schemas/Department'
        headquarters:
          $ref: '#/components/schemas/Address'
        contact:
          $ref: '#/components/schemas/ContactInfo'

    # Level 2: Department
    Department:
      type: object
      required:
        - id
        - name
        - teams
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        metadata:
          $ref: '#/components/schemas/EntityMetadata'
        teams:
          type: array
          items:
            $ref: '#/components/schemas/Team'
        manager:
          $ref: '#/components/schemas/Employee'
        budget:
          $ref: '#/components/schemas/Budget'

    # Level 3: Team
    Team:
      type: object
      required:
        - id
        - name
        - members
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        metadata:
          $ref: '#/components/schemas/EntityMetadata'
        members:
          type: array
          items:
            $ref: '#/components/schemas/TeamMember'
        lead:
          $ref: '#/components/schemas/Employee'
        projects:
          type: array
          items:
            $ref: '#/components/schemas/Project'

    # Level 4: TeamMember
    TeamMember:
      type: object
      required:
        - employee
        - role
      properties:
        employee:
          $ref: '#/components/schemas/Employee'
        role:
          $ref: '#/components/schemas/TeamRole'
        joinedAt:
          type: string
          format: date-time
        allocation:
          $ref: '#/components/schemas/Allocation'

    # Level 5: Employee (references multiple other schemas)
    Employee:
      type: object
      required:
        - id
        - personalInfo
        - employmentInfo
      properties:
        id:
          type: string
          format: uuid
        personalInfo:
          $ref: '#/components/schemas/PersonalInfo'
        employmentInfo:
          $ref: '#/components/schemas/EmploymentInfo'
        skills:
          type: array
          items:
            $ref: '#/components/schemas/Skill'
        certifications:
          type: array
          items:
            $ref: '#/components/schemas/Certification'

    # Level 6: PersonalInfo
    PersonalInfo:
      type: object
      required:
        - firstName
        - lastName
        - email
      properties:
        firstName:
          type: string
        lastName:
          type: string
        email:
          type: string
          format: email
        phone:
          $ref: '#/components/schemas/PhoneNumber'
        address:
          $ref: '#/components/schemas/Address'
        emergencyContact:
          $ref: '#/components/schemas/EmergencyContact'

    # Level 7: EmergencyContact (references PersonalInfo indirectly)
    EmergencyContact:
      type: object
      required:
        - name
        - relationship
        - phone
      properties:
        name:
          type: string
        relationship:
          type: string
        phone:
          $ref: '#/components/schemas/PhoneNumber'
        address:
          $ref: '#/components/schemas/Address'

    # Shared schemas referenced at multiple levels
    EntityMetadata:
      type: object
      properties:
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        createdBy:
          $ref: '#/components/schemas/AuditUser'
        updatedBy:
          $ref: '#/components/schemas/AuditUser'
        version:
          type: integer
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'

    AuditUser:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
          format: email

    Tag:
      type: object
      required:
        - key
        - value
      properties:
        key:
          type: string
        value:
          type: string

    Address:
      type: object
      properties:
        street:
          type: string
        city:
          type: string
        state:
          type: string
        postalCode:
          type: string
        country:
          $ref: '#/components/schemas/Country'
        coordinates:
          $ref: '#/components/schemas/GeoCoordinates'

    Country:
      type: object
      required:
        - code
        - name
      properties:
        code:
          type: string
          pattern: '^[A-Z]{2}$'
        name:
          type: string

    GeoCoordinates:
      type: object
      required:
        - latitude
        - longitude
      properties:
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180

    PhoneNumber:
      type: object
      required:
        - countryCode
        - number
      properties:
        countryCode:
          type: string
          pattern: '^\+[1-9]\d{0,2}$'
        number:
          type: string
        extension:
          type: string

    ContactInfo:
      type: object
      properties:
        email:
          type: string
          format: email
        phone:
          $ref: '#/components/schemas/PhoneNumber'
        website:
          type: string
          format: uri
        socialMedia:
          type: array
          items:
            $ref: '#/components/schemas/SocialMediaLink'

    SocialMediaLink:
      type: object
      required:
        - platform
        - url
      properties:
        platform:
          type: string
          enum:
            - linkedin
            - twitter
            - facebook
            - instagram
        url:
          type: string
          format: uri

    EmploymentInfo:
      type: object
      required:
        - startDate
        - status
        - position
      properties:
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        status:
          $ref: '#/components/schemas/EmploymentStatus'
        position:
          $ref: '#/components/schemas/Position'
        compensation:
          $ref: '#/components/schemas/Compensation'

    EmploymentStatus:
      type: string
      enum:
        - active
        - on_leave
        - terminated
        - retired

    Position:
      type: object
      required:
        - title
        - level
      properties:
        title:
          type: string
        level:
          $ref: '#/components/schemas/JobLevel'
        department:
          type: string

    JobLevel:
      type: object
      required:
        - code
        - name
        - rank
      properties:
        code:
          type: string
        name:
          type: string
        rank:
          type: integer
          minimum: 1
          maximum: 10

    Compensation:
      type: object
      properties:
        salary:
          $ref: '#/components/schemas/Money'
        bonus:
          $ref: '#/components/schemas/Money'
        equity:
          $ref: '#/components/schemas/EquityGrant'
        benefits:
          type: array
          items:
            $ref: '#/components/schemas/Benefit'

    Money:
      type: object
      required:
        - amount
        - currency
      properties:
        amount:
          type: number
          format: double
        currency:
          $ref: '#/components/schemas/Currency'

    Currency:
      type: object
      required:
        - code
      properties:
        code:
          type: string
          pattern: '^[A-Z]{3}$'
        symbol:
          type: string

    EquityGrant:
      type: object
      properties:
        shares:
          type: integer
        vestingSchedule:
          $ref: '#/components/schemas/VestingSchedule'
        grantDate:
          type: string
          format: date

    VestingSchedule:
      type: object
      properties:
        cliff:
          $ref: '#/components/schemas/Duration'
        totalPeriod:
          $ref: '#/components/schemas/Duration'
        frequency:
          type: string
          enum:
            - monthly
            - quarterly
            - annually

    Duration:
      type: object
      required:
        - value
        - unit
      properties:
        value:
          type: integer
        unit:
          type: string
          enum:
            - days
            - weeks
            - months
            - years

    Benefit:
      type: object
      required:
        - type
        - provider
      properties:
        type:
          type: string
          enum:
            - health
            - dental
            - vision
            - life
            - retirement
        provider:
          $ref: '#/components/schemas/BenefitProvider'
        coverage:
          $ref: '#/components/schemas/Coverage'

    BenefitProvider:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        contact:
          $ref: '#/components/schemas/ContactInfo'

    Coverage:
      type: object
      properties:
        level:
          type: string
          enum:
            - individual
            - family
        deductible:
          $ref: '#/components/schemas/Money'
        maxBenefit:
          $ref: '#/components/schemas/Money'

    Skill:
      type: object
      required:
        - name
        - proficiency
      properties:
        name:
          type: string
        proficiency:
          $ref: '#/components/schemas/ProficiencyLevel'
        yearsOfExperience:
          type: number

    ProficiencyLevel:
      type: string
      enum:
        - beginner
        - intermediate
        - advanced
        - expert

    Certification:
      type: object
      required:
        - name
        - issuer
      properties:
        name:
          type: string
        issuer:
          $ref: '#/components/schemas/CertificationIssuer'
        issuedDate:
          type: string
          format: date
        expiryDate:
          type: string
          format: date
        credentialId:
          type: string

    CertificationIssuer:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        website:
          type: string
          format: uri

    TeamRole:
      type: object
      required:
        - name
        - permissions
      properties:
        name:
          type: string
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/Permission'

    Permission:
      type: object
      required:
        - resource
        - actions
      properties:
        resource:
          type: string
        actions:
          type: array
          items:
            type: string
            enum:
              - read
              - write
              - delete
              - admin

    Allocation:
      type: object
      required:
        - percentage
      properties:
        percentage:
          type: integer
          minimum: 0
          maximum: 100
        effectiveFrom:
          type: string
          format: date
        effectiveTo:
          type: string
          format: date

    Project:
      type: object
      required:
        - id
        - name
        - status
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        status:
          $ref: '#/components/schemas/ProjectStatus'
        budget:
          $ref: '#/components/schemas/Budget'
        timeline:
          $ref: '#/components/schemas/Timeline'
        stakeholders:
          type: array
          items:
            $ref: '#/components/schemas/Stakeholder'

    ProjectStatus:
      type: string
      enum:
        - planning
        - in_progress
        - on_hold
        - completed
        - cancelled

    Budget:
      type: object
      properties:
        allocated:
          $ref: '#/components/schemas/Money'
        spent:
          $ref: '#/components/schemas/Money'
        remaining:
          $ref: '#/components/schemas/Money'

    Timeline:
      type: object
      properties:
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        milestones:
          type: array
          items:
            $ref: '#/components/schemas/Milestone'

    Milestone:
      type: object
      required:
        - name
        - dueDate
      properties:
        name:
          type: string
        dueDate:
          type: string
          format: date
        status:
          type: string
          enum:
            - pending
            - completed
            - overdue

    Stakeholder:
      type: object
      required:
        - employee
        - role
      properties:
        employee:
          $ref: '#/components/schemas/Employee'
        role:
          type: string
          enum:
            - sponsor
            - owner
            - contributor
            - reviewer

    # Summary schema that aggregates everything
    OrganizationSummary:
      type: object
      required:
        - organization
        - statistics
      properties:
        organization:
          $ref: '#/components/schemas/Organization'
        statistics:
          $ref: '#/components/schemas/OrganizationStatistics'

    OrganizationStatistics:
      type: object
      properties:
        totalEmployees:
          type: integer
        totalDepartments:
          type: integer
        totalTeams:
          type: integer
        totalProjects:
          type: integer
        budgetSummary:
          $ref: '#/components/schemas/Budget'

  parameters:
    OrgIdPath:
      name: orgId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    DeptIdPath:
      name: deptId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    TeamIdPath:
      name: teamId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  requestBodies:
    AddTeamMember:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - employeeId
              - role
            properties:
              employeeId:
                type: string
                format: uuid
              role:
                $ref: '#/components/schemas/TeamRole'
              allocation:
                $ref: '#/components/schemas/Allocation'

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              path:
                type: string
