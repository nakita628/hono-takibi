openapi: 3.1.0
info:
  title: E-Commerce API
  version: 1.0.0
  description: |
    Eコマースプラットフォーム用のAPI。
    商品管理、カート、注文処理、在庫管理などの機能を提供します。
  contact:
    name: API Support
    email: api@example.com

servers:
  - url: https://api.shop.example.com/v1
    description: Production
  - url: http://localhost:3000/v1
    description: Development

tags:
  - name: Products
    description: 商品管理
  - name: Categories
    description: カテゴリ管理
  - name: Cart
    description: ショッピングカート
  - name: Orders
    description: 注文管理
  - name: Inventory
    description: 在庫管理

paths:
  /products:
    get:
      tags:
        - Products
      operationId: listProducts
      summary: 商品一覧取得
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: category
          in: query
          description: カテゴリIDでフィルタ
          schema:
            type: string
        - name: minPrice
          in: query
          description: 最低価格
          schema:
            type: number
            minimum: 0
        - name: maxPrice
          in: query
          description: 最高価格
          schema:
            type: number
            minimum: 0
        - name: inStock
          in: query
          description: 在庫ありのみ
          schema:
            type: boolean
        - name: search
          in: query
          description: キーワード検索
          schema:
            type: string
        - name: sort
          in: query
          description: ソート順
          schema:
            type: string
            enum:
              - price:asc
              - price:desc
              - name:asc
              - name:desc
              - createdAt:desc
              - popularity:desc
      responses:
        '200':
          description: 商品一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductListResponse'
    post:
      tags:
        - Products
      operationId: createProduct
      summary: 商品作成
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProductRequest'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /products/{productId}:
    parameters:
      - $ref: '#/components/parameters/ProductIdParam'
    get:
      tags:
        - Products
      operationId: getProduct
      summary: 商品詳細取得
      responses:
        '200':
          description: 商品詳細
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags:
        - Products
      operationId: updateProduct
      summary: 商品更新
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProductRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags:
        - Products
      operationId: deleteProduct
      summary: 商品削除
      security:
        - bearerAuth: []
      responses:
        '204':
          description: 削除成功
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /products/{productId}/images:
    parameters:
      - $ref: '#/components/parameters/ProductIdParam'
    post:
      tags:
        - Products
      operationId: uploadProductImage
      summary: 商品画像アップロード
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                isPrimary:
                  type: boolean
                  default: false
      responses:
        '201':
          description: アップロード成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductImage'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /categories:
    get:
      tags:
        - Categories
      operationId: listCategories
      summary: カテゴリ一覧取得
      responses:
        '200':
          description: カテゴリ一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'
    post:
      tags:
        - Categories
      operationId: createCategory
      summary: カテゴリ作成
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCategoryRequest'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /cart:
    get:
      tags:
        - Cart
      operationId: getCart
      summary: カート取得
      security:
        - bearerAuth: []
      responses:
        '200':
          description: カート内容
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      tags:
        - Cart
      operationId: clearCart
      summary: カートをクリア
      security:
        - bearerAuth: []
      responses:
        '204':
          description: クリア成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /cart/items:
    post:
      tags:
        - Cart
      operationId: addToCart
      summary: カートに商品追加
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddToCartRequest'
      responses:
        '200':
          description: 追加成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /cart/items/{itemId}:
    parameters:
      - name: itemId
        in: path
        required: true
        schema:
          type: string
    put:
      tags:
        - Cart
      operationId: updateCartItem
      summary: カートアイテム数量変更
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - quantity
              properties:
                quantity:
                  type: integer
                  minimum: 1
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      tags:
        - Cart
      operationId: removeFromCart
      summary: カートから商品削除
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 削除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /orders:
    get:
      tags:
        - Orders
      operationId: listOrders
      summary: 注文一覧取得
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: status
          in: query
          description: ステータスでフィルタ
          schema:
            type: string
            enum:
              - pending
              - confirmed
              - processing
              - shipped
              - delivered
              - cancelled
      responses:
        '200':
          description: 注文一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags:
        - Orders
      operationId: createOrder
      summary: 注文作成
      description: カートの内容から注文を作成します
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '201':
          description: 注文作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /orders/{orderId}:
    parameters:
      - $ref: '#/components/parameters/OrderIdParam'
    get:
      tags:
        - Orders
      operationId: getOrder
      summary: 注文詳細取得
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 注文詳細
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /orders/{orderId}/cancel:
    parameters:
      - $ref: '#/components/parameters/OrderIdParam'
    post:
      tags:
        - Orders
      operationId: cancelOrder
      summary: 注文キャンセル
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: キャンセル理由
      responses:
        '200':
          description: キャンセル成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '400':
          description: キャンセルできない状態
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /inventory/{productId}:
    parameters:
      - $ref: '#/components/parameters/ProductIdParam'
    get:
      tags:
        - Inventory
      operationId: getInventory
      summary: 在庫情報取得
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 在庫情報
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Inventory'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags:
        - Inventory
      operationId: updateInventory
      summary: 在庫更新
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateInventoryRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Inventory'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    ProductIdParam:
      name: productId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    OrderIdParam:
      name: orderId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    PageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1

    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    Product:
      type: object
      required:
        - id
        - name
        - price
        - status
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        price:
          type: number
          minimum: 0
        compareAtPrice:
          type: number
          minimum: 0
          description: 割引前価格
        sku:
          type: string
        barcode:
          type: string
        category:
          $ref: '#/components/schemas/Category'
        images:
          type: array
          items:
            $ref: '#/components/schemas/ProductImage'
        status:
          type: string
          enum:
            - draft
            - active
            - archived
        inventory:
          $ref: '#/components/schemas/Inventory'
        attributes:
          type: object
          additionalProperties:
            type: string
        tags:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ProductImage:
      type: object
      required:
        - id
        - url
      properties:
        id:
          type: string
        url:
          type: string
          format: uri
        altText:
          type: string
        isPrimary:
          type: boolean
        sortOrder:
          type: integer

    Category:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        parentId:
          type: string
          format: uuid
        imageUrl:
          type: string
          format: uri
        productCount:
          type: integer

    Inventory:
      type: object
      required:
        - quantity
        - status
      properties:
        quantity:
          type: integer
          minimum: 0
        reservedQuantity:
          type: integer
          minimum: 0
        status:
          type: string
          enum:
            - in_stock
            - low_stock
            - out_of_stock
        lowStockThreshold:
          type: integer
        trackInventory:
          type: boolean

    Cart:
      type: object
      required:
        - id
        - items
        - subtotal
        - total
      properties:
        id:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        subtotal:
          type: number
        discount:
          type: number
        tax:
          type: number
        shipping:
          type: number
        total:
          type: number
        itemCount:
          type: integer

    CartItem:
      type: object
      required:
        - id
        - product
        - quantity
        - price
        - total
      properties:
        id:
          type: string
        product:
          $ref: '#/components/schemas/Product'
        quantity:
          type: integer
          minimum: 1
        price:
          type: number
        total:
          type: number

    Order:
      type: object
      required:
        - id
        - orderNumber
        - status
        - items
        - total
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        orderNumber:
          type: string
        status:
          type: string
          enum:
            - pending
            - confirmed
            - processing
            - shipped
            - delivered
            - cancelled
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        subtotal:
          type: number
        discount:
          type: number
        tax:
          type: number
        shipping:
          type: number
        total:
          type: number
        shippingAddress:
          $ref: '#/components/schemas/Address'
        billingAddress:
          $ref: '#/components/schemas/Address'
        paymentMethod:
          type: string
        paymentStatus:
          type: string
          enum:
            - pending
            - paid
            - failed
            - refunded
        notes:
          type: string
        trackingNumber:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OrderItem:
      type: object
      required:
        - id
        - productId
        - productName
        - quantity
        - price
        - total
      properties:
        id:
          type: string
        productId:
          type: string
          format: uuid
        productName:
          type: string
        sku:
          type: string
        quantity:
          type: integer
        price:
          type: number
        total:
          type: number
        imageUrl:
          type: string
          format: uri

    Address:
      type: object
      required:
        - name
        - postalCode
        - prefecture
        - city
        - address1
      properties:
        name:
          type: string
        postalCode:
          type: string
        prefecture:
          type: string
        city:
          type: string
        address1:
          type: string
        address2:
          type: string
        phone:
          type: string

    CreateProductRequest:
      type: object
      required:
        - name
        - price
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
        price:
          type: number
          minimum: 0
        compareAtPrice:
          type: number
          minimum: 0
        sku:
          type: string
        barcode:
          type: string
        categoryId:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - draft
            - active
          default: draft
        attributes:
          type: object
          additionalProperties:
            type: string
        tags:
          type: array
          items:
            type: string

    UpdateProductRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
        price:
          type: number
          minimum: 0
        compareAtPrice:
          type: number
          minimum: 0
        sku:
          type: string
        barcode:
          type: string
        categoryId:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - draft
            - active
            - archived
        attributes:
          type: object
          additionalProperties:
            type: string
        tags:
          type: array
          items:
            type: string

    CreateCategoryRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        parentId:
          type: string
          format: uuid

    AddToCartRequest:
      type: object
      required:
        - productId
        - quantity
      properties:
        productId:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1
          default: 1

    CreateOrderRequest:
      type: object
      required:
        - shippingAddress
        - paymentMethod
      properties:
        shippingAddress:
          $ref: '#/components/schemas/Address'
        billingAddress:
          $ref: '#/components/schemas/Address'
        paymentMethod:
          type: string
          enum:
            - credit_card
            - bank_transfer
            - convenience_store
            - cod
        notes:
          type: string
        couponCode:
          type: string

    UpdateInventoryRequest:
      type: object
      properties:
        quantity:
          type: integer
          minimum: 0
        lowStockThreshold:
          type: integer
        trackInventory:
          type: boolean

    ProductListResponse:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Product'
        pagination:
          $ref: '#/components/schemas/Pagination'

    OrderListResponse:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Order'
        pagination:
          $ref: '#/components/schemas/Pagination'

    Pagination:
      type: object
      required:
        - page
        - limit
        - total
        - totalPages
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

  responses:
    BadRequest:
      description: リクエストが不正です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: 認証が必要です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: リソースが見つかりません
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
