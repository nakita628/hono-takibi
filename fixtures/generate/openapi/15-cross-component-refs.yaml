openapi: 3.1.0
info:
  title: Cross-Component References API
  version: 1.0.0
  description: |
    Tests complex cross-references between different component types:
    - Schemas referencing parameters
    - Parameters referencing schemas
    - Responses referencing headers
    - Headers referencing schemas
    - RequestBodies referencing examples
    - Examples referencing schemas
    - Callbacks referencing all of the above
paths:
  /entities:
    get:
      operationId: listEntities
      parameters:
        - $ref: '#/components/parameters/FilterParam'
        - $ref: '#/components/parameters/PaginationParam'
        - $ref: '#/components/parameters/SortParam'
      responses:
        '200':
          $ref: '#/components/responses/EntityListResponse'
        '400':
          $ref: '#/components/responses/ValidationErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedResponse'
    post:
      operationId: createEntity
      parameters:
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        $ref: '#/components/requestBodies/CreateEntityBody'
      responses:
        '201':
          $ref: '#/components/responses/EntityCreatedResponse'
        '400':
          $ref: '#/components/responses/ValidationErrorResponse'
        '409':
          $ref: '#/components/responses/ConflictResponse'
      callbacks:
        onEntityCreated:
          $ref: '#/components/callbacks/EntityWebhook'

  /entities/{entityId}:
    parameters:
      - $ref: '#/components/parameters/EntityIdPath'
    get:
      operationId: getEntity
      parameters:
        - $ref: '#/components/parameters/IncludeParam'
        - $ref: '#/components/parameters/IfNoneMatchHeader'
      responses:
        '200':
          $ref: '#/components/responses/EntityResponse'
        '304':
          $ref: '#/components/responses/NotModifiedResponse'
        '404':
          $ref: '#/components/responses/NotFoundResponse'
    put:
      operationId: updateEntity
      parameters:
        - $ref: '#/components/parameters/IfMatchHeader'
      requestBody:
        $ref: '#/components/requestBodies/UpdateEntityBody'
      responses:
        '200':
          $ref: '#/components/responses/EntityResponse'
        '404':
          $ref: '#/components/responses/NotFoundResponse'
        '409':
          $ref: '#/components/responses/ConflictResponse'
        '412':
          $ref: '#/components/responses/PreconditionFailedResponse'
      callbacks:
        onEntityUpdated:
          $ref: '#/components/callbacks/EntityWebhook'
    delete:
      operationId: deleteEntity
      parameters:
        - $ref: '#/components/parameters/IfMatchHeader'
      responses:
        '204':
          $ref: '#/components/responses/NoContentResponse'
        '404':
          $ref: '#/components/responses/NotFoundResponse'
      callbacks:
        onEntityDeleted:
          $ref: '#/components/callbacks/EntityWebhook'

  /entities/{entityId}/relationships:
    parameters:
      - $ref: '#/components/parameters/EntityIdPath'
    get:
      operationId: getEntityRelationships
      responses:
        '200':
          $ref: '#/components/responses/RelationshipListResponse'
    post:
      operationId: createRelationship
      requestBody:
        $ref: '#/components/requestBodies/CreateRelationshipBody'
      responses:
        '201':
          $ref: '#/components/responses/RelationshipResponse'

  /batch:
    post:
      operationId: batchOperation
      requestBody:
        $ref: '#/components/requestBodies/BatchOperationBody'
      responses:
        '200':
          $ref: '#/components/responses/BatchResultResponse'
        '207':
          $ref: '#/components/responses/MultiStatusResponse'

components:
  schemas:
    # Core entity schema - referenced by many components
    Entity:
      type: object
      required:
        - id
        - type
        - attributes
      properties:
        id:
          $ref: '#/components/schemas/EntityId'
        type:
          $ref: '#/components/schemas/EntityType'
        attributes:
          $ref: '#/components/schemas/EntityAttributes'
        relationships:
          $ref: '#/components/schemas/EntityRelationships'
        meta:
          $ref: '#/components/schemas/EntityMeta'
        links:
          $ref: '#/components/schemas/EntityLinks'

    EntityId:
      type: string
      format: uuid
      description: Unique entity identifier

    EntityType:
      type: string
      enum:
        - user
        - organization
        - project
        - resource
      description: Entity type discriminator

    EntityAttributes:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        status:
          $ref: '#/components/schemas/EntityStatus'
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
        customFields:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/CustomFieldValue'
      additionalProperties: true

    EntityStatus:
      type: string
      enum:
        - active
        - inactive
        - pending
        - archived

    Tag:
      type: object
      required:
        - key
        - value
      properties:
        key:
          type: string
          maxLength: 50
        value:
          type: string
          maxLength: 200

    CustomFieldValue:
      oneOf:
        - type: string
        - type: number
        - type: boolean
        - type: array
          items:
            type: string
        - $ref: '#/components/schemas/NestedCustomField'

    NestedCustomField:
      type: object
      additionalProperties:
        $ref: '#/components/schemas/CustomFieldValue'

    EntityRelationships:
      type: object
      properties:
        parent:
          $ref: '#/components/schemas/RelationshipLink'
        children:
          $ref: '#/components/schemas/RelationshipLinks'
        owner:
          $ref: '#/components/schemas/RelationshipLink'
        members:
          $ref: '#/components/schemas/RelationshipLinks'

    RelationshipLink:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/ResourceIdentifier'
        links:
          $ref: '#/components/schemas/RelationshipLinkUrls'
        meta:
          $ref: '#/components/schemas/RelationshipMeta'

    RelationshipLinks:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ResourceIdentifier'
        links:
          $ref: '#/components/schemas/RelationshipLinkUrls'
        meta:
          $ref: '#/components/schemas/RelationshipMeta'

    ResourceIdentifier:
      type: object
      required:
        - type
        - id
      properties:
        type:
          $ref: '#/components/schemas/EntityType'
        id:
          $ref: '#/components/schemas/EntityId'

    RelationshipLinkUrls:
      type: object
      properties:
        self:
          type: string
          format: uri
        related:
          type: string
          format: uri

    RelationshipMeta:
      type: object
      properties:
        count:
          type: integer
        createdAt:
          type: string
          format: date-time

    EntityMeta:
      type: object
      properties:
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        version:
          type: integer
        etag:
          type: string
        permissions:
          $ref: '#/components/schemas/Permissions'

    Permissions:
      type: object
      properties:
        canRead:
          type: boolean
        canWrite:
          type: boolean
        canDelete:
          type: boolean
        canShare:
          type: boolean

    EntityLinks:
      type: object
      properties:
        self:
          type: string
          format: uri
        collection:
          type: string
          format: uri
        related:
          type: object
          additionalProperties:
            type: string
            format: uri

    # Request/Response wrapper schemas
    EntityListWrapper:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Entity'
        included:
          type: array
          items:
            $ref: '#/components/schemas/Entity'
        meta:
          $ref: '#/components/schemas/ListMeta'
        links:
          $ref: '#/components/schemas/PaginationLinks'

    EntityWrapper:
      type: object
      required:
        - data
      properties:
        data:
          $ref: '#/components/schemas/Entity'
        included:
          type: array
          items:
            $ref: '#/components/schemas/Entity'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ListMeta:
      type: object
      properties:
        total:
          type: integer
        page:
          type: integer
        perPage:
          type: integer
        totalPages:
          type: integer

    ResponseMeta:
      type: object
      properties:
        requestId:
          type: string
          format: uuid
        processingTime:
          type: number

    PaginationLinks:
      type: object
      properties:
        self:
          type: string
          format: uri
        first:
          type: string
          format: uri
        last:
          type: string
          format: uri
        prev:
          type: string
          format: uri
        next:
          type: string
          format: uri

    # Input schemas
    CreateEntityInput:
      type: object
      required:
        - type
        - attributes
      properties:
        type:
          $ref: '#/components/schemas/EntityType'
        attributes:
          $ref: '#/components/schemas/EntityAttributes'
        relationships:
          $ref: '#/components/schemas/EntityRelationships'

    UpdateEntityInput:
      type: object
      properties:
        attributes:
          $ref: '#/components/schemas/EntityAttributes'
        relationships:
          $ref: '#/components/schemas/EntityRelationships'

    CreateRelationshipInput:
      type: object
      required:
        - type
        - targetId
      properties:
        type:
          type: string
        targetId:
          $ref: '#/components/schemas/EntityId'
        meta:
          $ref: '#/components/schemas/RelationshipMeta'

    # Error schemas
    Error:
      type: object
      required:
        - status
        - code
        - title
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
        code:
          type: string
        title:
          type: string
        detail:
          type: string
        source:
          $ref: '#/components/schemas/ErrorSource'
        meta:
          $ref: '#/components/schemas/ErrorMeta'

    ErrorSource:
      type: object
      properties:
        pointer:
          type: string
        parameter:
          type: string
        header:
          type: string

    ErrorMeta:
      type: object
      additionalProperties: true

    ErrorList:
      type: object
      required:
        - errors
      properties:
        errors:
          type: array
          items:
            $ref: '#/components/schemas/Error'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Batch operation schemas
    BatchOperation:
      type: object
      required:
        - method
        - path
      properties:
        id:
          type: string
        method:
          type: string
          enum:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
        path:
          type: string
        headers:
          type: object
          additionalProperties:
            type: string
        body:
          oneOf:
            - $ref: '#/components/schemas/CreateEntityInput'
            - $ref: '#/components/schemas/UpdateEntityInput'

    BatchResult:
      type: object
      required:
        - responses
      properties:
        responses:
          type: array
          items:
            $ref: '#/components/schemas/BatchResponseItem'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    BatchResponseItem:
      type: object
      required:
        - id
        - status
      properties:
        id:
          type: string
        status:
          type: integer
        headers:
          type: object
          additionalProperties:
            type: string
        body:
          oneOf:
            - $ref: '#/components/schemas/EntityWrapper'
            - $ref: '#/components/schemas/ErrorList'

    # Webhook payload schema
    WebhookPayload:
      type: object
      required:
        - event
        - data
        - timestamp
      properties:
        id:
          type: string
          format: uuid
        event:
          $ref: '#/components/schemas/WebhookEvent'
        data:
          $ref: '#/components/schemas/Entity'
        previousData:
          $ref: '#/components/schemas/Entity'
        timestamp:
          type: string
          format: date-time
        meta:
          $ref: '#/components/schemas/WebhookMeta'

    WebhookEvent:
      type: string
      enum:
        - entity.created
        - entity.updated
        - entity.deleted

    WebhookMeta:
      type: object
      properties:
        triggeredBy:
          $ref: '#/components/schemas/ResourceIdentifier'
        correlationId:
          type: string

    # Filter schema - used by parameters
    FilterExpression:
      type: object
      properties:
        field:
          type: string
        operator:
          type: string
          enum:
            - eq
            - ne
            - gt
            - gte
            - lt
            - lte
            - in
            - nin
            - contains
            - startsWith
            - endsWith
        value:
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: array
              items:
                type: string
        and:
          type: array
          items:
            $ref: '#/components/schemas/FilterExpression'
        or:
          type: array
          items:
            $ref: '#/components/schemas/FilterExpression'

    # Pagination schema - used by parameters
    PaginationInput:
      type: object
      properties:
        page:
          type: integer
          minimum: 1
          default: 1
        perPage:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
        cursor:
          type: string

    # Sort schema - used by parameters
    SortExpression:
      type: object
      properties:
        field:
          type: string
        direction:
          type: string
          enum:
            - asc
            - desc
          default: asc

  parameters:
    EntityIdPath:
      name: entityId
      in: path
      required: true
      description: Entity unique identifier
      schema:
        $ref: '#/components/schemas/EntityId'
      examples:
        validUuid:
          $ref: '#/components/examples/EntityIdExample'

    FilterParam:
      name: filter
      in: query
      description: Filter expression
      required: false
      style: deepObject
      explode: true
      schema:
        $ref: '#/components/schemas/FilterExpression'
      examples:
        simpleFilter:
          $ref: '#/components/examples/SimpleFilterExample'
        complexFilter:
          $ref: '#/components/examples/ComplexFilterExample'

    PaginationParam:
      name: page
      in: query
      description: Pagination parameters
      required: false
      style: deepObject
      explode: true
      schema:
        $ref: '#/components/schemas/PaginationInput'

    SortParam:
      name: sort
      in: query
      description: Sort expression
      required: false
      style: form
      explode: true
      schema:
        type: array
        items:
          $ref: '#/components/schemas/SortExpression'

    IncludeParam:
      name: include
      in: query
      description: Related resources to include
      required: false
      schema:
        type: array
        items:
          type: string
          enum:
            - parent
            - children
            - owner
            - members
      style: form
      explode: false

    IfMatchHeader:
      name: If-Match
      in: header
      description: ETag for optimistic locking
      required: false
      schema:
        type: string
      examples:
        etag:
          $ref: '#/components/examples/EtagExample'

    IfNoneMatchHeader:
      name: If-None-Match
      in: header
      description: ETag for cache validation
      required: false
      schema:
        type: string

    IdempotencyKeyHeader:
      name: Idempotency-Key
      in: header
      description: Idempotency key for safe retries
      required: false
      schema:
        type: string
        format: uuid
      examples:
        idempotencyKey:
          $ref: '#/components/examples/IdempotencyKeyExample'

  responses:
    EntityListResponse:
      description: List of entities
      headers:
        X-Total-Count:
          $ref: '#/components/headers/XTotalCount'
        X-Page:
          $ref: '#/components/headers/XPage'
        X-Per-Page:
          $ref: '#/components/headers/XPerPage'
        Link:
          $ref: '#/components/headers/LinkHeader'
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/EntityListWrapper'
          examples:
            entityList:
              $ref: '#/components/examples/EntityListExample'

    EntityResponse:
      description: Single entity
      headers:
        ETag:
          $ref: '#/components/headers/ETag'
        Last-Modified:
          $ref: '#/components/headers/LastModified'
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/EntityWrapper'
          examples:
            entity:
              $ref: '#/components/examples/EntityExample'

    EntityCreatedResponse:
      description: Entity created
      headers:
        Location:
          $ref: '#/components/headers/Location'
        ETag:
          $ref: '#/components/headers/ETag'
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/EntityWrapper'
          examples:
            createdEntity:
              $ref: '#/components/examples/CreatedEntityExample'

    RelationshipListResponse:
      description: List of relationships
      headers:
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/RelationshipLinks'

    RelationshipResponse:
      description: Single relationship
      headers:
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/RelationshipLink'

    BatchResultResponse:
      description: Batch operation result (all succeeded)
      headers:
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BatchResult'

    MultiStatusResponse:
      description: Batch operation result (partial success)
      headers:
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BatchResult'

    NoContentResponse:
      description: No content
      headers:
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'

    NotModifiedResponse:
      description: Not modified
      headers:
        ETag:
          $ref: '#/components/headers/ETag'
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'

    ValidationErrorResponse:
      description: Validation error
      headers:
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorList'
          examples:
            validationError:
              $ref: '#/components/examples/ValidationErrorExample'

    UnauthorizedResponse:
      description: Unauthorized
      headers:
        WWW-Authenticate:
          $ref: '#/components/headers/WWWAuthenticate'
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorList'

    NotFoundResponse:
      description: Not found
      headers:
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorList'
          examples:
            notFound:
              $ref: '#/components/examples/NotFoundErrorExample'

    ConflictResponse:
      description: Conflict
      headers:
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorList'

    PreconditionFailedResponse:
      description: Precondition failed
      headers:
        X-Request-Id:
          $ref: '#/components/headers/XRequestId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorList'

  headers:
    XRequestId:
      description: Unique request identifier
      required: true
      schema:
        type: string
        format: uuid
      example:
        $ref: '#/components/examples/RequestIdExample'

    XTotalCount:
      description: Total number of items
      schema:
        type: integer

    XPage:
      description: Current page number
      schema:
        type: integer

    XPerPage:
      description: Items per page
      schema:
        type: integer

    LinkHeader:
      description: Pagination links (RFC 5988)
      schema:
        type: string

    ETag:
      description: Entity tag
      required: true
      schema:
        type: string

    LastModified:
      description: Last modification date
      schema:
        type: string
        format: date-time

    Location:
      description: Created resource URL
      required: true
      schema:
        type: string
        format: uri

    WWWAuthenticate:
      description: Authentication challenge
      required: true
      schema:
        type: string

  requestBodies:
    CreateEntityBody:
      description: Create entity request
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CreateEntityInput'
          examples:
            createUser:
              $ref: '#/components/examples/CreateUserExample'
            createProject:
              $ref: '#/components/examples/CreateProjectExample'

    UpdateEntityBody:
      description: Update entity request
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/UpdateEntityInput'
          examples:
            updateEntity:
              $ref: '#/components/examples/UpdateEntityExample'

    CreateRelationshipBody:
      description: Create relationship request
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CreateRelationshipInput'

    BatchOperationBody:
      description: Batch operation request
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - operations
            properties:
              operations:
                type: array
                items:
                  $ref: '#/components/schemas/BatchOperation'
                minItems: 1
                maxItems: 100

  examples:
    EntityIdExample:
      summary: Valid entity ID
      value: 550e8400-e29b-41d4-a716-446655440000

    EtagExample:
      summary: ETag value
      value: '"33a64df551425fcc55e4d42a148795d9f25f89d4"'

    IdempotencyKeyExample:
      summary: Idempotency key
      value: 7c9e6679-7425-40de-944b-e07fc1f90ae7

    RequestIdExample:
      summary: Request ID
      value: req-550e8400-e29b-41d4-a716-446655440000

    SimpleFilterExample:
      summary: Simple filter
      value:
        field: status
        operator: eq
        value: active

    ComplexFilterExample:
      summary: Complex filter with AND/OR
      value:
        and:
          - field: status
            operator: eq
            value: active
          - or:
              - field: type
                operator: eq
                value: user
              - field: type
                operator: eq
                value: project

    EntityExample:
      summary: Complete entity
      value:
        data:
          id: 550e8400-e29b-41d4-a716-446655440000
          type: user
          attributes:
            name: John Doe
            status: active
          relationships:
            owner:
              data:
                type: organization
                id: 660e8400-e29b-41d4-a716-446655440001
          meta:
            createdAt: '2024-01-15T10:30:00Z'
            version: 1

    EntityListExample:
      summary: Entity list
      value:
        data:
          - id: 550e8400-e29b-41d4-a716-446655440000
            type: user
            attributes:
              name: John Doe
        meta:
          total: 1
          page: 1
          perPage: 20

    CreatedEntityExample:
      summary: Newly created entity
      value:
        data:
          id: 550e8400-e29b-41d4-a716-446655440000
          type: user
          attributes:
            name: John Doe
            status: active

    CreateUserExample:
      summary: Create user request
      value:
        type: user
        attributes:
          name: John Doe
          status: active

    CreateProjectExample:
      summary: Create project request
      value:
        type: project
        attributes:
          name: New Project
          description: Project description

    UpdateEntityExample:
      summary: Update entity request
      value:
        attributes:
          name: Updated Name
          status: inactive

    ValidationErrorExample:
      summary: Validation error response
      value:
        errors:
          - status: '400'
            code: VALIDATION_ERROR
            title: Validation Failed
            detail: Name is required
            source:
              pointer: /data/attributes/name

    NotFoundErrorExample:
      summary: Not found error response
      value:
        errors:
          - status: '404'
            code: NOT_FOUND
            title: Resource Not Found
            detail: Entity with ID 550e8400-e29b-41d4-a716-446655440000 not found

  callbacks:
    EntityWebhook:
      '{$request.header.X-Callback-Url}':
        post:
          operationId: entityWebhookCallback
          parameters:
            - $ref: '#/components/parameters/IdempotencyKeyHeader'
          requestBody:
            required: true
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/WebhookPayload'
                examples:
                  created:
                    summary: Entity created event
                    value:
                      event: entity.created
                      data:
                        id: 550e8400-e29b-41d4-a716-446655440000
                        type: user
                      timestamp: '2024-01-15T10:30:00Z'
          responses:
            '200':
              description: Webhook received
              headers:
                X-Request-Id:
                  $ref: '#/components/headers/XRequestId'
            '400':
              $ref: '#/components/responses/ValidationErrorResponse'

  links:
    GetEntityById:
      operationId: getEntity
      parameters:
        entityId: '$response.body#/data/id'

    GetEntityRelationships:
      operationId: getEntityRelationships
      parameters:
        entityId: '$response.body#/data/id'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - bearerAuth: []
