openapi: 3.1.0
info:
  title: Circular References API
  version: 1.0.0
  description: |
    Tests various circular reference patterns:
    - Self-referencing schemas
    - Mutual circular references (A -> B -> A)
    - Indirect circular references (A -> B -> C -> A)
    - Circular references in arrays
    - Circular references in additionalProperties
    - Circular references through allOf/oneOf/anyOf
paths:
  /trees:
    get:
      operationId: getTrees
      responses:
        '200':
          description: Tree structures
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TreeNode'
    post:
      operationId: createTree
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TreeNode'
      responses:
        '201':
          description: Created

  /graphs:
    get:
      operationId: getGraphs
      responses:
        '200':
          description: Graph structures
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Graph'

  /linked-lists:
    get:
      operationId: getLinkedLists
      responses:
        '200':
          description: Linked list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LinkedListNode'

  /social-network:
    get:
      operationId: getSocialNetwork
      responses:
        '200':
          description: Social network data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SocialUser'

  /file-system:
    get:
      operationId: getFileSystem
      responses:
        '200':
          description: File system structure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileSystemEntry'

  /comments:
    get:
      operationId: getComments
      responses:
        '200':
          description: Nested comments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Comment'

  /polymorphic:
    get:
      operationId: getPolymorphic
      responses:
        '200':
          description: Polymorphic circular reference
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Expression'

  /categories:
    get:
      operationId: getCategories
      responses:
        '200':
          description: Category hierarchy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'

  /workflow:
    get:
      operationId: getWorkflow
      responses:
        '200':
          description: Workflow with circular state transitions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowState'

components:
  schemas:
    # Pattern 1: Simple self-reference (tree)
    TreeNode:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: string
          format: uuid
        value:
          type: string
        parent:
          $ref: '#/components/schemas/TreeNode'
        children:
          type: array
          items:
            $ref: '#/components/schemas/TreeNode'
        metadata:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/TreeNode'

    # Pattern 2: Doubly-linked list (prev/next)
    LinkedListNode:
      type: object
      required:
        - value
      properties:
        value:
          type: string
        prev:
          $ref: '#/components/schemas/LinkedListNode'
        next:
          $ref: '#/components/schemas/LinkedListNode'
        list:
          $ref: '#/components/schemas/LinkedList'

    LinkedList:
      type: object
      properties:
        head:
          $ref: '#/components/schemas/LinkedListNode'
        tail:
          $ref: '#/components/schemas/LinkedListNode'
        length:
          type: integer

    # Pattern 3: Graph with nodes and edges
    Graph:
      type: object
      required:
        - nodes
      properties:
        id:
          type: string
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/GraphNode'
        metadata:
          $ref: '#/components/schemas/GraphMetadata'

    GraphNode:
      type: object
      required:
        - id
      properties:
        id:
          type: string
        data:
          type: object
        edges:
          type: array
          items:
            $ref: '#/components/schemas/GraphEdge'
        graph:
          $ref: '#/components/schemas/Graph'

    GraphEdge:
      type: object
      required:
        - source
        - target
      properties:
        id:
          type: string
        source:
          $ref: '#/components/schemas/GraphNode'
        target:
          $ref: '#/components/schemas/GraphNode'
        weight:
          type: number
        metadata:
          $ref: '#/components/schemas/EdgeMetadata'

    GraphMetadata:
      type: object
      properties:
        name:
          type: string
        rootNode:
          $ref: '#/components/schemas/GraphNode'

    EdgeMetadata:
      type: object
      properties:
        label:
          type: string
        relatedEdges:
          type: array
          items:
            $ref: '#/components/schemas/GraphEdge'

    # Pattern 4: Mutual circular reference (A <-> B)
    SocialUser:
      type: object
      required:
        - id
        - username
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string
        profile:
          $ref: '#/components/schemas/UserProfile'
        followers:
          type: array
          items:
            $ref: '#/components/schemas/SocialUser'
        following:
          type: array
          items:
            $ref: '#/components/schemas/SocialUser'
        posts:
          type: array
          items:
            $ref: '#/components/schemas/Post'
        blockedUsers:
          type: array
          items:
            $ref: '#/components/schemas/SocialUser'

    UserProfile:
      type: object
      properties:
        bio:
          type: string
        avatar:
          type: string
          format: uri
        user:
          $ref: '#/components/schemas/SocialUser'
        settings:
          $ref: '#/components/schemas/ProfileSettings'

    ProfileSettings:
      type: object
      properties:
        privacy:
          type: string
        notifications:
          type: boolean
        profile:
          $ref: '#/components/schemas/UserProfile'

    Post:
      type: object
      required:
        - id
        - content
        - author
      properties:
        id:
          type: string
        content:
          type: string
        author:
          $ref: '#/components/schemas/SocialUser'
        likes:
          type: array
          items:
            $ref: '#/components/schemas/SocialUser'
        reposts:
          type: array
          items:
            $ref: '#/components/schemas/Post'
        replyTo:
          $ref: '#/components/schemas/Post'
        replies:
          type: array
          items:
            $ref: '#/components/schemas/Post'
        mentions:
          type: array
          items:
            $ref: '#/components/schemas/SocialUser'

    # Pattern 5: Indirect circular (A -> B -> C -> A)
    FileSystemEntry:
      type: object
      required:
        - name
        - type
      properties:
        name:
          type: string
        type:
          type: string
          enum:
            - file
            - directory
            - symlink
        permissions:
          $ref: '#/components/schemas/FilePermissions'
        owner:
          $ref: '#/components/schemas/FileOwner'

    FilePermissions:
      type: object
      properties:
        read:
          type: boolean
        write:
          type: boolean
        execute:
          type: boolean
        acl:
          type: array
          items:
            $ref: '#/components/schemas/AccessControlEntry'

    AccessControlEntry:
      type: object
      properties:
        principal:
          $ref: '#/components/schemas/FileOwner'
        permissions:
          $ref: '#/components/schemas/FilePermissions'
        entry:
          $ref: '#/components/schemas/FileSystemEntry'

    FileOwner:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        ownedFiles:
          type: array
          items:
            $ref: '#/components/schemas/FileSystemEntry'
        homeDirectory:
          $ref: '#/components/schemas/FileSystemEntry'

    # Pattern 6: Nested comments (self-reference with depth)
    Comment:
      type: object
      required:
        - id
        - content
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        author:
          $ref: '#/components/schemas/CommentAuthor'
        parent:
          $ref: '#/components/schemas/Comment'
        replies:
          type: array
          items:
            $ref: '#/components/schemas/Comment'
        thread:
          $ref: '#/components/schemas/CommentThread'
        quotedComment:
          $ref: '#/components/schemas/Comment'

    CommentAuthor:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        recentComments:
          type: array
          items:
            $ref: '#/components/schemas/Comment'

    CommentThread:
      type: object
      properties:
        id:
          type: string
        rootComment:
          $ref: '#/components/schemas/Comment'
        allComments:
          type: array
          items:
            $ref: '#/components/schemas/Comment'

    # Pattern 7: Circular reference through oneOf/anyOf
    Expression:
      oneOf:
        - $ref: '#/components/schemas/LiteralExpression'
        - $ref: '#/components/schemas/BinaryExpression'
        - $ref: '#/components/schemas/UnaryExpression'
        - $ref: '#/components/schemas/ConditionalExpression'
        - $ref: '#/components/schemas/FunctionCallExpression'

    LiteralExpression:
      type: object
      required:
        - type
        - value
      properties:
        type:
          type: string
          const: literal
        value:
          oneOf:
            - type: string
            - type: number
            - type: boolean

    BinaryExpression:
      type: object
      required:
        - type
        - operator
        - left
        - right
      properties:
        type:
          type: string
          const: binary
        operator:
          type: string
          enum:
            - '+'
            - '-'
            - '*'
            - '/'
            - '=='
            - '!='
            - '<'
            - '>'
            - '&&'
            - '||'
        left:
          $ref: '#/components/schemas/Expression'
        right:
          $ref: '#/components/schemas/Expression'

    UnaryExpression:
      type: object
      required:
        - type
        - operator
        - operand
      properties:
        type:
          type: string
          const: unary
        operator:
          type: string
          enum:
            - '-'
            - '!'
            - '~'
        operand:
          $ref: '#/components/schemas/Expression'

    ConditionalExpression:
      type: object
      required:
        - type
        - condition
        - consequent
        - alternate
      properties:
        type:
          type: string
          const: conditional
        condition:
          $ref: '#/components/schemas/Expression'
        consequent:
          $ref: '#/components/schemas/Expression'
        alternate:
          $ref: '#/components/schemas/Expression'

    FunctionCallExpression:
      type: object
      required:
        - type
        - callee
        - arguments
      properties:
        type:
          type: string
          const: call
        callee:
          $ref: '#/components/schemas/Expression'
        arguments:
          type: array
          items:
            $ref: '#/components/schemas/Expression'

    # Pattern 8: Category hierarchy with circular parent/children
    Category:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
        name:
          type: string
        parent:
          $ref: '#/components/schemas/Category'
        children:
          type: array
          items:
            $ref: '#/components/schemas/Category'
        ancestors:
          type: array
          items:
            $ref: '#/components/schemas/Category'
        descendants:
          type: array
          items:
            $ref: '#/components/schemas/Category'
        relatedCategories:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/Category'
        products:
          type: array
          items:
            $ref: '#/components/schemas/CategorizedProduct'

    CategorizedProduct:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        primaryCategory:
          $ref: '#/components/schemas/Category'
        secondaryCategories:
          type: array
          items:
            $ref: '#/components/schemas/Category'

    # Pattern 9: Workflow state machine with circular transitions
    WorkflowState:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        transitions:
          type: array
          items:
            $ref: '#/components/schemas/StateTransition'
        entryActions:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowAction'
        exitActions:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowAction'
        parentState:
          $ref: '#/components/schemas/WorkflowState'
        childStates:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowState'

    StateTransition:
      type: object
      required:
        - event
        - targetState
      properties:
        event:
          type: string
        sourceState:
          $ref: '#/components/schemas/WorkflowState'
        targetState:
          $ref: '#/components/schemas/WorkflowState'
        guard:
          $ref: '#/components/schemas/TransitionGuard'
        actions:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowAction'

    TransitionGuard:
      type: object
      properties:
        condition:
          type: string
        relatedTransitions:
          type: array
          items:
            $ref: '#/components/schemas/StateTransition'

    WorkflowAction:
      type: object
      properties:
        type:
          type: string
        config:
          type: object
        nextAction:
          $ref: '#/components/schemas/WorkflowAction'
        fallbackAction:
          $ref: '#/components/schemas/WorkflowAction'
        triggerTransition:
          $ref: '#/components/schemas/StateTransition'

    # Pattern 10: Circular through allOf
    BaseEntity:
      type: object
      properties:
        id:
          type: string
        relatedEntity:
          $ref: '#/components/schemas/ExtendedEntity'

    ExtendedEntity:
      allOf:
        - $ref: '#/components/schemas/BaseEntity'
        - type: object
          properties:
            name:
              type: string
            parent:
              $ref: '#/components/schemas/ExtendedEntity'
            baseReference:
              $ref: '#/components/schemas/BaseEntity'

    # Pattern 11: Map with circular values
    RecursiveMap:
      type: object
      properties:
        key:
          type: string
        value:
          type: string
        nested:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/RecursiveMap'
        items:
          type: array
          items:
            $ref: '#/components/schemas/RecursiveMap'

    # Pattern 12: Nullable circular reference
    NullableCircular:
      type: object
      properties:
        id:
          type: string
        next:
          oneOf:
            - $ref: '#/components/schemas/NullableCircular'
            - type: 'null'
        prev:
          type:
            - object
            - 'null'
          properties:
            id:
              type: string
            next:
              $ref: '#/components/schemas/NullableCircular'
