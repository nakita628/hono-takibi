openapi: 3.1.0
info:
  title: Complex Schemas API
  version: 1.0.0
paths:
  /events:
    post:
      operationId: createEvent
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Event'
      responses:
        '201':
          description: Event created
  /notifications:
    post:
      operationId: sendNotification
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Notification'
      responses:
        '200':
          description: Notification sent
  /shapes:
    post:
      operationId: createShape
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Shape'
      responses:
        '201':
          description: Shape created
  /documents:
    post:
      operationId: createDocument
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Document'
      responses:
        '201':
          description: Document created
  /mixed:
    post:
      operationId: processMixed
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MixedContent'
      responses:
        '200':
          description: Processed
components:
  schemas:
    # oneOf with discriminator
    Event:
      oneOf:
        - $ref: '#/components/schemas/UserEvent'
        - $ref: '#/components/schemas/OrderEvent'
        - $ref: '#/components/schemas/SystemEvent'
      discriminator:
        propertyName: eventType
        mapping:
          user.created: '#/components/schemas/UserEvent'
          user.updated: '#/components/schemas/UserEvent'
          user.deleted: '#/components/schemas/UserEvent'
          order.placed: '#/components/schemas/OrderEvent'
          order.shipped: '#/components/schemas/OrderEvent'
          order.delivered: '#/components/schemas/OrderEvent'
          system.startup: '#/components/schemas/SystemEvent'
          system.shutdown: '#/components/schemas/SystemEvent'
    
    BaseEvent:
      type: object
      required:
        - id
        - eventType
        - timestamp
      properties:
        id:
          type: string
          format: uuid
        eventType:
          type: string
        timestamp:
          type: string
          format: date-time
        metadata:
          type: object
          additionalProperties: true
    
    UserEvent:
      allOf:
        - $ref: '#/components/schemas/BaseEvent'
        - type: object
          required:
            - userId
          properties:
            eventType:
              type: string
              enum:
                - user.created
                - user.updated
                - user.deleted
            userId:
              type: string
              format: uuid
            userData:
              type: object
              properties:
                email:
                  type: string
                  format: email
                name:
                  type: string
    
    OrderEvent:
      allOf:
        - $ref: '#/components/schemas/BaseEvent'
        - type: object
          required:
            - orderId
          properties:
            eventType:
              type: string
              enum:
                - order.placed
                - order.shipped
                - order.delivered
            orderId:
              type: string
              format: uuid
            orderData:
              type: object
              properties:
                total:
                  type: number
                  format: float64
                items:
                  type: integer
    
    SystemEvent:
      allOf:
        - $ref: '#/components/schemas/BaseEvent'
        - type: object
          required:
            - component
          properties:
            eventType:
              type: string
              enum:
                - system.startup
                - system.shutdown
            component:
              type: string
            details:
              type: string

    # anyOf example
    Notification:
      type: object
      required:
        - recipient
        - content
      properties:
        recipient:
          anyOf:
            - $ref: '#/components/schemas/EmailRecipient'
            - $ref: '#/components/schemas/SmsRecipient'
            - $ref: '#/components/schemas/PushRecipient'
            - $ref: '#/components/schemas/MultiRecipient'
        content:
          $ref: '#/components/schemas/NotificationContent'
        priority:
          type: string
          enum:
            - low
            - normal
            - high
            - urgent
    
    EmailRecipient:
      type: object
      required:
        - type
        - email
      properties:
        type:
          type: string
          const: email
        email:
          type: string
          format: email
        name:
          type: string
    
    SmsRecipient:
      type: object
      required:
        - type
        - phoneNumber
      properties:
        type:
          type: string
          const: sms
        phoneNumber:
          type: string
          pattern: '^\+[1-9]\d{1,14}$'
    
    PushRecipient:
      type: object
      required:
        - type
        - deviceToken
      properties:
        type:
          type: string
          const: push
        deviceToken:
          type: string
        platform:
          type: string
          enum:
            - ios
            - android
            - web
    
    MultiRecipient:
      type: object
      required:
        - type
        - recipients
      properties:
        type:
          type: string
          const: multi
        recipients:
          type: array
          minItems: 1
          items:
            anyOf:
              - $ref: '#/components/schemas/EmailRecipient'
              - $ref: '#/components/schemas/SmsRecipient'
              - $ref: '#/components/schemas/PushRecipient'
    
    NotificationContent:
      type: object
      required:
        - title
        - body
      properties:
        title:
          type: string
          maxLength: 100
        body:
          type: string
          maxLength: 1000
        imageUrl:
          type: string
          format: uri
        actionUrl:
          type: string
          format: uri

    # oneOf without discriminator (for polymorphic shapes)
    Shape:
      oneOf:
        - $ref: '#/components/schemas/Circle'
        - $ref: '#/components/schemas/Rectangle'
        - $ref: '#/components/schemas/Triangle'
        - $ref: '#/components/schemas/Polygon'
    
    Circle:
      type: object
      required:
        - type
        - radius
      properties:
        type:
          type: string
          const: circle
        radius:
          type: number
          format: float64
          exclusiveMinimum: 0
        center:
          $ref: '#/components/schemas/Point'
    
    Rectangle:
      type: object
      required:
        - type
        - width
        - height
      properties:
        type:
          type: string
          const: rectangle
        width:
          type: number
          format: float64
          exclusiveMinimum: 0
        height:
          type: number
          format: float64
          exclusiveMinimum: 0
        topLeft:
          $ref: '#/components/schemas/Point'
    
    Triangle:
      type: object
      required:
        - type
        - vertices
      properties:
        type:
          type: string
          const: triangle
        vertices:
          type: array
          items:
            $ref: '#/components/schemas/Point'
          minItems: 3
          maxItems: 3
    
    Polygon:
      type: object
      required:
        - type
        - vertices
      properties:
        type:
          type: string
          const: polygon
        vertices:
          type: array
          items:
            $ref: '#/components/schemas/Point'
          minItems: 3
    
    Point:
      type: object
      required:
        - x
        - y
      properties:
        x:
          type: number
          format: float64
        y:
          type: number
          format: float64

    # allOf for inheritance/composition
    Document:
      allOf:
        - $ref: '#/components/schemas/BaseDocument'
        - $ref: '#/components/schemas/Auditable'
        - $ref: '#/components/schemas/Taggable'
        - type: object
          properties:
            content:
              type: string
            format:
              type: string
              enum:
                - markdown
                - html
                - plain
    
    BaseDocument:
      type: object
      required:
        - id
        - title
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
    
    Auditable:
      type: object
      properties:
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
        updatedAt:
          type: string
          format: date-time
        updatedBy:
          type: string
        version:
          type: integer
          format: int32
    
    Taggable:
      type: object
      properties:
        tags:
          type: array
          items:
            type: string
          uniqueItems: true
        categories:
          type: array
          items:
            type: string

    # Complex nested structure with not
    MixedContent:
      type: object
      required:
        - value
      properties:
        value:
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: array
              items:
                $ref: '#/components/schemas/MixedContent'
            - type: object
              additionalProperties:
                $ref: '#/components/schemas/MixedContent'
        # not example: value cannot be null
        notNull:
          not:
            type: 'null'
        # Complex validation
        restrictedValue:
          allOf:
            - type: string
            - not:
                enum:
                  - forbidden
                  - restricted
                  - banned

    # Nullable and type arrays
    NullableTypes:
      type: object
      properties:
        nullableString:
          type:
            - string
            - 'null'
        nullableNumber:
          type:
            - number
            - 'null'
        nullableArray:
          type:
            - array
            - 'null'
          items:
            type: string
        multiType:
          type:
            - string
            - number
            - boolean
        deprecated:
          type: string
          deprecated: true
