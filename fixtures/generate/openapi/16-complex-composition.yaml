openapi: 3.1.0
info:
  title: Complex Composition References API
  version: 1.0.0
  description: |
    Tests complex combinations of allOf, oneOf, anyOf with $ref:
    - Nested allOf/oneOf/anyOf
    - Multiple levels of composition
    - Discriminators with complex mappings
    - Composition with additionalProperties
    - Composition with required fields merging
paths:
  /messages:
    post:
      operationId: sendMessage
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Message'
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'

  /events:
    post:
      operationId: processEvent
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Event'
      responses:
        '200':
          description: Event processed

  /configs:
    get:
      operationId: getConfig
      responses:
        '200':
          description: Configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Configuration'
    put:
      operationId: updateConfig
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigurationUpdate'
      responses:
        '200':
          description: Updated

  /resources:
    post:
      operationId: createResource
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Resource'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Resource'

  /validations:
    post:
      operationId: validate
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidationRequest'
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'

components:
  schemas:
    # ========================================
    # Pattern 1: Nested allOf with $ref chains
    # ========================================
    
    # Base trait schemas
    Identifiable:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          format: uuid

    Timestamped:
      type: object
      properties:
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Auditable:
      allOf:
        - $ref: '#/components/schemas/Timestamped'
        - type: object
          properties:
            createdBy:
              type: string
            updatedBy:
              type: string

    Versionable:
      type: object
      properties:
        version:
          type: integer
        etag:
          type: string

    # Combined traits
    BaseEntity:
      allOf:
        - $ref: '#/components/schemas/Identifiable'
        - $ref: '#/components/schemas/Auditable'
        - $ref: '#/components/schemas/Versionable'

    # Extended entity with more allOf
    ExtendedEntity:
      allOf:
        - $ref: '#/components/schemas/BaseEntity'
        - type: object
          required:
            - name
          properties:
            name:
              type: string
            description:
              type: string
            tags:
              type: array
              items:
                type: string

    # ========================================
    # Pattern 2: oneOf with discriminator and nested allOf
    # ========================================
    
    Message:
      oneOf:
        - $ref: '#/components/schemas/TextMessage'
        - $ref: '#/components/schemas/ImageMessage'
        - $ref: '#/components/schemas/VideoMessage'
        - $ref: '#/components/schemas/DocumentMessage'
        - $ref: '#/components/schemas/CompositeMessage'
      discriminator:
        propertyName: type
        mapping:
          text: '#/components/schemas/TextMessage'
          image: '#/components/schemas/ImageMessage'
          video: '#/components/schemas/VideoMessage'
          document: '#/components/schemas/DocumentMessage'
          composite: '#/components/schemas/CompositeMessage'

    BaseMessage:
      allOf:
        - $ref: '#/components/schemas/BaseEntity'
        - type: object
          required:
            - type
            - sender
            - recipient
          properties:
            type:
              type: string
            sender:
              $ref: '#/components/schemas/Participant'
            recipient:
              $ref: '#/components/schemas/Participant'
            metadata:
              $ref: '#/components/schemas/MessageMetadata'

    Participant:
      allOf:
        - $ref: '#/components/schemas/Identifiable'
        - type: object
          required:
            - name
          properties:
            name:
              type: string
            avatar:
              type: string
              format: uri

    MessageMetadata:
      type: object
      properties:
        priority:
          type: string
          enum: [low, normal, high, urgent]
        expiresAt:
          type: string
          format: date-time
        replyTo:
          $ref: '#/components/schemas/Message'

    TextMessage:
      allOf:
        - $ref: '#/components/schemas/BaseMessage'
        - type: object
          required:
            - content
          properties:
            type:
              type: string
              const: text
            content:
              type: string
            formatting:
              $ref: '#/components/schemas/TextFormatting'

    TextFormatting:
      type: object
      properties:
        bold:
          type: array
          items:
            $ref: '#/components/schemas/TextRange'
        italic:
          type: array
          items:
            $ref: '#/components/schemas/TextRange'
        links:
          type: array
          items:
            $ref: '#/components/schemas/LinkRange'

    TextRange:
      type: object
      required:
        - start
        - end
      properties:
        start:
          type: integer
        end:
          type: integer

    LinkRange:
      allOf:
        - $ref: '#/components/schemas/TextRange'
        - type: object
          required:
            - url
          properties:
            url:
              type: string
              format: uri

    ImageMessage:
      allOf:
        - $ref: '#/components/schemas/BaseMessage'
        - $ref: '#/components/schemas/MediaContent'
        - type: object
          properties:
            type:
              type: string
              const: image
            dimensions:
              $ref: '#/components/schemas/Dimensions'
            alt:
              type: string

    VideoMessage:
      allOf:
        - $ref: '#/components/schemas/BaseMessage'
        - $ref: '#/components/schemas/MediaContent'
        - type: object
          properties:
            type:
              type: string
              const: video
            duration:
              type: integer
            thumbnail:
              $ref: '#/components/schemas/ImageMessage'

    DocumentMessage:
      allOf:
        - $ref: '#/components/schemas/BaseMessage'
        - $ref: '#/components/schemas/MediaContent'
        - type: object
          properties:
            type:
              type: string
              const: document
            pageCount:
              type: integer
            preview:
              $ref: '#/components/schemas/ImageMessage'

    MediaContent:
      type: object
      required:
        - url
        - mimeType
        - size
      properties:
        url:
          type: string
          format: uri
        mimeType:
          type: string
        size:
          type: integer
        checksum:
          type: string

    Dimensions:
      type: object
      required:
        - width
        - height
      properties:
        width:
          type: integer
        height:
          type: integer

    # Recursive oneOf - CompositeMessage contains Message[]
    CompositeMessage:
      allOf:
        - $ref: '#/components/schemas/BaseMessage'
        - type: object
          required:
            - parts
          properties:
            type:
              type: string
              const: composite
            parts:
              type: array
              items:
                $ref: '#/components/schemas/Message'
              minItems: 2

    MessageResponse:
      allOf:
        - $ref: '#/components/schemas/Message'
        - type: object
          properties:
            deliveryStatus:
              $ref: '#/components/schemas/DeliveryStatus'

    DeliveryStatus:
      type: object
      properties:
        sent:
          type: boolean
        delivered:
          type: boolean
        read:
          type: boolean
        timestamps:
          type: object
          properties:
            sentAt:
              type: string
              format: date-time
            deliveredAt:
              type: string
              format: date-time
            readAt:
              type: string
              format: date-time

    # ========================================
    # Pattern 3: anyOf with complex conditions
    # ========================================

    Event:
      type: object
      required:
        - eventType
        - payload
      properties:
        eventType:
          type: string
        payload:
          $ref: '#/components/schemas/EventPayload'
        context:
          $ref: '#/components/schemas/EventContext'

    EventPayload:
      anyOf:
        - $ref: '#/components/schemas/UserEventPayload'
        - $ref: '#/components/schemas/OrderEventPayload'
        - $ref: '#/components/schemas/SystemEventPayload'
        - $ref: '#/components/schemas/CustomEventPayload'

    UserEventPayload:
      allOf:
        - $ref: '#/components/schemas/BaseEventPayload'
        - type: object
          required:
            - userId
          properties:
            userId:
              type: string
              format: uuid
            userAction:
              type: string
              enum: [login, logout, register, update, delete]
            previousState:
              $ref: '#/components/schemas/UserState'
            newState:
              $ref: '#/components/schemas/UserState'

    OrderEventPayload:
      allOf:
        - $ref: '#/components/schemas/BaseEventPayload'
        - type: object
          required:
            - orderId
          properties:
            orderId:
              type: string
            orderAction:
              type: string
              enum: [created, updated, cancelled, completed]
            items:
              type: array
              items:
                $ref: '#/components/schemas/OrderItem'

    SystemEventPayload:
      allOf:
        - $ref: '#/components/schemas/BaseEventPayload'
        - type: object
          required:
            - component
            - severity
          properties:
            component:
              type: string
            severity:
              type: string
              enum: [info, warning, error, critical]
            metrics:
              type: object
              additionalProperties:
                type: number

    CustomEventPayload:
      allOf:
        - $ref: '#/components/schemas/BaseEventPayload'
        - type: object
          properties:
            customType:
              type: string
            data:
              type: object
              additionalProperties: true

    BaseEventPayload:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        source:
          type: string
        correlationId:
          type: string

    UserState:
      type: object
      properties:
        status:
          type: string
        roles:
          type: array
          items:
            type: string
        preferences:
          type: object

    OrderItem:
      type: object
      required:
        - productId
        - quantity
      properties:
        productId:
          type: string
        quantity:
          type: integer
        price:
          type: number

    EventContext:
      anyOf:
        - $ref: '#/components/schemas/WebContext'
        - $ref: '#/components/schemas/MobileContext'
        - $ref: '#/components/schemas/ApiContext'

    WebContext:
      type: object
      properties:
        userAgent:
          type: string
        referrer:
          type: string
        sessionId:
          type: string

    MobileContext:
      type: object
      properties:
        deviceId:
          type: string
        platform:
          type: string
          enum: [ios, android]
        appVersion:
          type: string

    ApiContext:
      type: object
      properties:
        apiKey:
          type: string
        clientId:
          type: string
        ipAddress:
          type: string

    # ========================================
    # Pattern 4: Mixed composition with additionalProperties
    # ========================================

    Configuration:
      allOf:
        - $ref: '#/components/schemas/BaseEntity'
        - type: object
          required:
            - settings
          properties:
            settings:
              $ref: '#/components/schemas/ConfigSettings'
            overrides:
              type: object
              additionalProperties:
                $ref: '#/components/schemas/ConfigValue'

    ConfigSettings:
      type: object
      properties:
        general:
          $ref: '#/components/schemas/GeneralSettings'
        features:
          $ref: '#/components/schemas/FeatureFlags'
        limits:
          $ref: '#/components/schemas/RateLimits'
      additionalProperties:
        $ref: '#/components/schemas/ConfigSection'

    GeneralSettings:
      allOf:
        - $ref: '#/components/schemas/ConfigSection'
        - type: object
          properties:
            environment:
              type: string
            debug:
              type: boolean
            logLevel:
              type: string

    FeatureFlags:
      allOf:
        - $ref: '#/components/schemas/ConfigSection'
        - type: object
          additionalProperties:
            $ref: '#/components/schemas/FeatureFlag'

    FeatureFlag:
      oneOf:
        - type: boolean
        - $ref: '#/components/schemas/ConditionalFeatureFlag'

    ConditionalFeatureFlag:
      type: object
      required:
        - enabled
      properties:
        enabled:
          type: boolean
        conditions:
          type: array
          items:
            $ref: '#/components/schemas/FeatureCondition'
        rolloutPercentage:
          type: integer
          minimum: 0
          maximum: 100

    FeatureCondition:
      anyOf:
        - $ref: '#/components/schemas/UserCondition'
        - $ref: '#/components/schemas/TimeCondition'
        - $ref: '#/components/schemas/GeoCondition'

    UserCondition:
      type: object
      required:
        - type
        - userIds
      properties:
        type:
          type: string
          const: user
        userIds:
          type: array
          items:
            type: string

    TimeCondition:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          const: time
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time

    GeoCondition:
      type: object
      required:
        - type
        - regions
      properties:
        type:
          type: string
          const: geo
        regions:
          type: array
          items:
            type: string

    RateLimits:
      allOf:
        - $ref: '#/components/schemas/ConfigSection'
        - type: object
          additionalProperties:
            $ref: '#/components/schemas/RateLimit'

    RateLimit:
      type: object
      required:
        - limit
        - window
      properties:
        limit:
          type: integer
        window:
          type: integer
        burstLimit:
          type: integer

    ConfigSection:
      type: object
      properties:
        enabled:
          type: boolean
        description:
          type: string

    ConfigValue:
      oneOf:
        - type: string
        - type: number
        - type: boolean
        - type: array
          items:
            $ref: '#/components/schemas/ConfigValue'
        - type: object
          additionalProperties:
            $ref: '#/components/schemas/ConfigValue'

    ConfigurationUpdate:
      allOf:
        - type: object
          properties:
            settings:
              $ref: '#/components/schemas/ConfigSettings'
            overrides:
              type: object
              additionalProperties:
                $ref: '#/components/schemas/ConfigValue'
        - $ref: '#/components/schemas/Versionable'

    # ========================================
    # Pattern 5: Complex Resource with multiple inheritance paths
    # ========================================

    Resource:
      oneOf:
        - $ref: '#/components/schemas/ComputeResource'
        - $ref: '#/components/schemas/StorageResource'
        - $ref: '#/components/schemas/NetworkResource'
        - $ref: '#/components/schemas/CompositeResource'
      discriminator:
        propertyName: resourceType
        mapping:
          compute: '#/components/schemas/ComputeResource'
          storage: '#/components/schemas/StorageResource'
          network: '#/components/schemas/NetworkResource'
          composite: '#/components/schemas/CompositeResource'

    BaseResource:
      allOf:
        - $ref: '#/components/schemas/ExtendedEntity'
        - type: object
          required:
            - resourceType
            - status
          properties:
            resourceType:
              type: string
            status:
              $ref: '#/components/schemas/ResourceStatus'
            dependencies:
              type: array
              items:
                $ref: '#/components/schemas/ResourceDependency'
            cost:
              $ref: '#/components/schemas/ResourceCost'

    ResourceStatus:
      type: object
      required:
        - state
      properties:
        state:
          type: string
          enum: [pending, provisioning, running, stopped, failed, terminated]
        health:
          type: string
          enum: [healthy, degraded, unhealthy, unknown]
        lastChecked:
          type: string
          format: date-time

    ResourceDependency:
      type: object
      required:
        - resourceId
        - type
      properties:
        resourceId:
          type: string
        type:
          type: string
          enum: [hard, soft]
        resource:
          $ref: '#/components/schemas/Resource'

    ResourceCost:
      type: object
      properties:
        hourly:
          type: number
        monthly:
          type: number
        currency:
          type: string

    ComputeResource:
      allOf:
        - $ref: '#/components/schemas/BaseResource'
        - type: object
          required:
            - cpu
            - memory
          properties:
            resourceType:
              type: string
              const: compute
            cpu:
              $ref: '#/components/schemas/CpuSpec'
            memory:
              $ref: '#/components/schemas/MemorySpec'
            storage:
              type: array
              items:
                $ref: '#/components/schemas/StorageResource'

    CpuSpec:
      type: object
      required:
        - cores
      properties:
        cores:
          type: integer
        architecture:
          type: string

    MemorySpec:
      type: object
      required:
        - size
      properties:
        size:
          type: integer
        unit:
          type: string
          enum: [MB, GB, TB]

    StorageResource:
      allOf:
        - $ref: '#/components/schemas/BaseResource'
        - type: object
          required:
            - size
            - storageType
          properties:
            resourceType:
              type: string
              const: storage
            size:
              type: integer
            storageType:
              type: string
              enum: [ssd, hdd, nvme]
            iops:
              type: integer
            attachedTo:
              $ref: '#/components/schemas/ComputeResource'

    NetworkResource:
      allOf:
        - $ref: '#/components/schemas/BaseResource'
        - type: object
          required:
            - cidr
          properties:
            resourceType:
              type: string
              const: network
            cidr:
              type: string
            subnets:
              type: array
              items:
                $ref: '#/components/schemas/NetworkResource'
            parentNetwork:
              $ref: '#/components/schemas/NetworkResource'
            connectedResources:
              type: array
              items:
                anyOf:
                  - $ref: '#/components/schemas/ComputeResource'
                  - $ref: '#/components/schemas/StorageResource'

    CompositeResource:
      allOf:
        - $ref: '#/components/schemas/BaseResource'
        - type: object
          required:
            - components
          properties:
            resourceType:
              type: string
              const: composite
            components:
              type: array
              items:
                $ref: '#/components/schemas/Resource'
            template:
              $ref: '#/components/schemas/ResourceTemplate'

    ResourceTemplate:
      type: object
      properties:
        name:
          type: string
        version:
          type: string
        parameters:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ConfigValue'

    # ========================================
    # Pattern 6: Validation with complex schema combinations
    # ========================================

    ValidationRequest:
      type: object
      required:
        - target
        - rules
      properties:
        target:
          $ref: '#/components/schemas/ValidationTarget'
        rules:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRule'

    ValidationTarget:
      oneOf:
        - $ref: '#/components/schemas/Resource'
        - $ref: '#/components/schemas/Configuration'
        - $ref: '#/components/schemas/Message'

    ValidationRule:
      allOf:
        - type: object
          required:
            - ruleType
          properties:
            ruleType:
              type: string
            severity:
              type: string
              enum: [error, warning, info]
        - oneOf:
            - $ref: '#/components/schemas/SchemaValidationRule'
            - $ref: '#/components/schemas/BusinessValidationRule'
            - $ref: '#/components/schemas/CustomValidationRule'

    SchemaValidationRule:
      type: object
      required:
        - schema
      properties:
        ruleType:
          type: string
          const: schema
        schema:
          type: object

    BusinessValidationRule:
      type: object
      required:
        - expression
      properties:
        ruleType:
          type: string
          const: business
        expression:
          type: string
        parameters:
          type: object

    CustomValidationRule:
      type: object
      required:
        - handler
      properties:
        ruleType:
          type: string
          const: custom
        handler:
          type: string
        config:
          type: object

    ValidationResult:
      type: object
      required:
        - valid
        - issues
      properties:
        valid:
          type: boolean
        issues:
          type: array
          items:
            $ref: '#/components/schemas/ValidationIssue'
        metadata:
          type: object

    ValidationIssue:
      allOf:
        - type: object
          required:
            - path
            - message
            - severity
          properties:
            path:
              type: string
            message:
              type: string
            severity:
              type: string
              enum: [error, warning, info]
            code:
              type: string
        - anyOf:
            - $ref: '#/components/schemas/SchemaIssue'
            - $ref: '#/components/schemas/BusinessIssue'

    SchemaIssue:
      type: object
      properties:
        keyword:
          type: string
        expected:
          type: object
        actual:
          type: object

    BusinessIssue:
      type: object
      properties:
        rule:
          type: string
        context:
          type: object
