openapi: 3.1.0
info:
  title: Mixed References API
  version: 1.0.0
  description: |
    Tests complex reference patterns including:
    - Inline schemas vs $ref schemas
    - Partial references (referencing nested properties)
    - References with overrides (allOf + inline)
    - Dynamic references with runtime resolution patterns
    - Reference chains through multiple components
paths:
  /users:
    get:
      operationId: listUsers
      parameters:
        # Inline parameter
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, pending]
        # Referenced parameter
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
        # Inline with referenced schema
        - name: filter
          in: query
          schema:
            $ref: '#/components/schemas/UserFilter'
      responses:
        '200':
          description: User list
          content:
            application/json:
              schema:
                # Inline schema with referenced items
                type: object
                required:
                  - data
                  - pagination
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  _links:
                    type: object
                    properties:
                      self:
                        type: string
                        format: uri
                      next:
                        type: string
                        format: uri
    post:
      operationId: createUser
      requestBody:
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/CreateUserInput'
                - type: object
                  properties:
                    invitationCode:
                      type: string
                    preferences:
                      $ref: '#/components/schemas/UserPreferences'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /users/{userId}:
    parameters:
      - $ref: '#/components/parameters/UserIdPath'
    get:
      operationId: getUser
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/User'
                  computed:
                    type: object
                    properties:
                      fullName:
                        type: string
                      membershipDuration:
                        type: string
                  embedded:
                    type: object
                    properties:
                      organization:
                        $ref: '#/components/schemas/Organization'
                      teams:
                        type: array
                        items:
                          $ref: '#/components/schemas/Team'

  /orders:
    post:
      operationId: createOrder
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderInput'
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                type: object
                required:
                  - order
                  - payment
                properties:
                  order:
                    $ref: '#/components/schemas/Order'
                  payment:
                    oneOf:
                      - $ref: '#/components/schemas/CreditCardPayment'
                      - $ref: '#/components/schemas/BankTransferPayment'
                      - type: object
                        required:
                          - method
                        properties:
                          method:
                            type: string
                            const: invoice
                          invoiceAddress:
                            $ref: '#/components/schemas/Address'
                          paymentTerms:
                            type: integer
                            default: 30
                  shipping:
                    $ref: '#/components/schemas/ShippingInfo'

  /products/{productId}/variants:
    parameters:
      - name: productId
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: getProductVariants
      responses:
        '200':
          description: Product variants
          content:
            application/json:
              schema:
                type: array
                items:
                  # allOf combining base + inline extensions
                  allOf:
                    - $ref: '#/components/schemas/ProductVariant'
                    - type: object
                      properties:
                        # Inline pricing with ref
                        pricing:
                          allOf:
                            - $ref: '#/components/schemas/Price'
                            - type: object
                              properties:
                                discounts:
                                  type: array
                                  items:
                                    $ref: '#/components/schemas/Discount'
                        # Deeply nested inline + ref mix
                        availability:
                          type: object
                          properties:
                            inStock:
                              type: boolean
                            quantity:
                              type: integer
                            warehouses:
                              type: array
                              items:
                                allOf:
                                  - $ref: '#/components/schemas/Warehouse'
                                  - type: object
                                    properties:
                                      localQuantity:
                                        type: integer
                                      estimatedDelivery:
                                        $ref: '#/components/schemas/DateRange'

  /reports/generate:
    post:
      operationId: generateReport
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - reportType
                - parameters
              properties:
                reportType:
                  type: string
                  enum: [sales, inventory, users, custom]
                parameters:
                  # anyOf with mix of refs and inline
                  anyOf:
                    - $ref: '#/components/schemas/SalesReportParams'
                    - $ref: '#/components/schemas/InventoryReportParams'
                    - $ref: '#/components/schemas/UserReportParams'
                    - type: object
                      description: Custom report parameters
                      properties:
                        query:
                          type: string
                        fields:
                          type: array
                          items:
                            type: string
                        filters:
                          type: object
                          additionalProperties:
                            oneOf:
                              - type: string
                              - type: number
                              - $ref: '#/components/schemas/FilterExpression'
                format:
                  $ref: '#/components/schemas/ReportFormat'
                delivery:
                  # Inline object with referenced nested types
                  type: object
                  properties:
                    method:
                      type: string
                      enum: [download, email, webhook]
                    email:
                      $ref: '#/components/schemas/EmailDelivery'
                    webhook:
                      $ref: '#/components/schemas/WebhookDelivery'
      responses:
        '202':
          description: Report generation started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportJob'

  /webhooks/test:
    post:
      operationId: testWebhook
      requestBody:
        content:
          application/json:
            schema:
              # Deep inline with strategic refs
              type: object
              required:
                - endpoint
                - payload
              properties:
                endpoint:
                  type: string
                  format: uri
                headers:
                  type: object
                  additionalProperties:
                    type: string
                payload:
                  # Very complex nested structure
                  type: object
                  properties:
                    event:
                      $ref: '#/components/schemas/WebhookEvent'
                    data:
                      oneOf:
                        - $ref: '#/components/schemas/User'
                        - $ref: '#/components/schemas/Order'
                        - $ref: '#/components/schemas/Organization'
                        - type: object
                          additionalProperties:
                            anyOf:
                              - type: string
                              - type: number
                              - type: boolean
                              - type: array
                                items:
                                  $ref: '#/components/schemas/GenericEntity'
                    context:
                      allOf:
                        - $ref: '#/components/schemas/RequestContext'
                        - type: object
                          properties:
                            testMode:
                              type: boolean
                              default: true
                            mockResponses:
                              type: array
                              items:
                                type: object
                                properties:
                                  status:
                                    type: integer
                                  body:
                                    type: object
                retryPolicy:
                  $ref: '#/components/schemas/RetryPolicy'
      responses:
        '200':
          description: Test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookTestResult'

components:
  schemas:
    # Base schemas
    User:
      type: object
      required:
        - id
        - email
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        profile:
          $ref: '#/components/schemas/UserProfile'
        settings:
          $ref: '#/components/schemas/UserSettings'
        metadata:
          $ref: '#/components/schemas/EntityMetadata'

    UserProfile:
      type: object
      properties:
        firstName:
          type: string
        lastName:
          type: string
        avatar:
          type: string
          format: uri
        bio:
          type: string
        social:
          type: object
          additionalProperties:
            type: string
            format: uri

    UserSettings:
      type: object
      properties:
        notifications:
          $ref: '#/components/schemas/NotificationSettings'
        privacy:
          $ref: '#/components/schemas/PrivacySettings'
        preferences:
          $ref: '#/components/schemas/UserPreferences'

    UserPreferences:
      type: object
      properties:
        language:
          type: string
        timezone:
          type: string
        theme:
          type: string
          enum: [light, dark, system]
        dateFormat:
          type: string

    NotificationSettings:
      type: object
      properties:
        email:
          type: boolean
        push:
          type: boolean
        sms:
          type: boolean
        channels:
          type: object
          additionalProperties:
            type: boolean

    PrivacySettings:
      type: object
      properties:
        profileVisibility:
          type: string
          enum: [public, private, connections]
        showEmail:
          type: boolean
        showActivity:
          type: boolean

    CreateUserInput:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
        profile:
          $ref: '#/components/schemas/UserProfile'
        password:
          type: string
          format: password

    UserFilter:
      type: object
      properties:
        status:
          type: array
          items:
            type: string
        createdAfter:
          type: string
          format: date-time
        createdBefore:
          type: string
          format: date-time
        search:
          type: string

    Organization:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        address:
          $ref: '#/components/schemas/Address'
        members:
          type: array
          items:
            $ref: '#/components/schemas/OrganizationMember'

    OrganizationMember:
      type: object
      required:
        - user
        - role
      properties:
        user:
          $ref: '#/components/schemas/User'
        role:
          type: string
          enum: [owner, admin, member, viewer]
        joinedAt:
          type: string
          format: date-time

    Team:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        members:
          type: array
          items:
            $ref: '#/components/schemas/User'

    Address:
      type: object
      properties:
        street:
          type: string
        city:
          type: string
        state:
          type: string
        postalCode:
          type: string
        country:
          type: string

    Order:
      type: object
      required:
        - id
        - items
        - total
      properties:
        id:
          type: string
          format: uuid
        customer:
          $ref: '#/components/schemas/User'
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        total:
          $ref: '#/components/schemas/Price'
        status:
          type: string
          enum: [pending, confirmed, shipped, delivered, cancelled]
        shippingAddress:
          $ref: '#/components/schemas/Address'
        billingAddress:
          $ref: '#/components/schemas/Address'

    OrderItem:
      type: object
      required:
        - product
        - quantity
        - price
      properties:
        product:
          $ref: '#/components/schemas/ProductVariant'
        quantity:
          type: integer
          minimum: 1
        price:
          $ref: '#/components/schemas/Price'

    CreateOrderInput:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          items:
            type: object
            required:
              - productId
              - variantId
              - quantity
            properties:
              productId:
                type: string
              variantId:
                type: string
              quantity:
                type: integer
        shippingAddress:
          $ref: '#/components/schemas/Address'
        billingAddress:
          $ref: '#/components/schemas/Address'
        paymentMethod:
          oneOf:
            - $ref: '#/components/schemas/CreditCardPayment'
            - $ref: '#/components/schemas/BankTransferPayment'

    ProductVariant:
      type: object
      required:
        - id
        - sku
        - name
      properties:
        id:
          type: string
          format: uuid
        sku:
          type: string
        name:
          type: string
        attributes:
          type: object
          additionalProperties:
            type: string
        price:
          $ref: '#/components/schemas/Price'

    Price:
      type: object
      required:
        - amount
        - currency
      properties:
        amount:
          type: number
          format: double
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
        formatted:
          type: string

    Discount:
      type: object
      required:
        - type
        - value
      properties:
        type:
          type: string
          enum: [percentage, fixed]
        value:
          type: number
        code:
          type: string
        validUntil:
          type: string
          format: date-time

    CreditCardPayment:
      type: object
      required:
        - method
        - cardToken
      properties:
        method:
          type: string
          const: credit_card
        cardToken:
          type: string
        saveCard:
          type: boolean

    BankTransferPayment:
      type: object
      required:
        - method
        - bankAccount
      properties:
        method:
          type: string
          const: bank_transfer
        bankAccount:
          type: string
        routingNumber:
          type: string

    ShippingInfo:
      type: object
      properties:
        carrier:
          type: string
        method:
          type: string
        trackingNumber:
          type: string
        estimatedDelivery:
          $ref: '#/components/schemas/DateRange'
        cost:
          $ref: '#/components/schemas/Price'

    Warehouse:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
        name:
          type: string
        address:
          $ref: '#/components/schemas/Address'
        capacity:
          type: integer

    DateRange:
      type: object
      properties:
        from:
          type: string
          format: date
        to:
          type: string
          format: date

    # Report schemas
    SalesReportParams:
      type: object
      required:
        - dateRange
      properties:
        dateRange:
          $ref: '#/components/schemas/DateRange'
        groupBy:
          type: string
          enum: [day, week, month, quarter]
        metrics:
          type: array
          items:
            type: string
            enum: [revenue, orders, avgOrderValue, customers]

    InventoryReportParams:
      type: object
      properties:
        warehouses:
          type: array
          items:
            type: string
        categories:
          type: array
          items:
            type: string
        lowStockThreshold:
          type: integer

    UserReportParams:
      type: object
      properties:
        dateRange:
          $ref: '#/components/schemas/DateRange'
        segments:
          type: array
          items:
            type: string
        includeInactive:
          type: boolean

    FilterExpression:
      type: object
      properties:
        operator:
          type: string
          enum: [eq, ne, gt, gte, lt, lte, in, contains]
        value:
          oneOf:
            - type: string
            - type: number
            - type: array
              items:
                type: string

    ReportFormat:
      type: object
      properties:
        type:
          type: string
          enum: [json, csv, xlsx, pdf]
        options:
          type: object
          additionalProperties: true

    EmailDelivery:
      type: object
      required:
        - recipients
      properties:
        recipients:
          type: array
          items:
            type: string
            format: email
        subject:
          type: string
        message:
          type: string

    WebhookDelivery:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          format: uri
        headers:
          type: object
          additionalProperties:
            type: string
        retryPolicy:
          $ref: '#/components/schemas/RetryPolicy'

    ReportJob:
      type: object
      required:
        - id
        - status
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum: [queued, processing, completed, failed]
        progress:
          type: integer
          minimum: 0
          maximum: 100
        result:
          type: object
          properties:
            url:
              type: string
              format: uri
            expiresAt:
              type: string
              format: date-time
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

    # Webhook schemas
    WebhookEvent:
      type: object
      required:
        - type
        - timestamp
      properties:
        type:
          type: string
        timestamp:
          type: string
          format: date-time
        version:
          type: string

    GenericEntity:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        attributes:
          type: object
          additionalProperties: true

    RequestContext:
      type: object
      properties:
        requestId:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        source:
          type: string
        userAgent:
          type: string

    RetryPolicy:
      type: object
      properties:
        maxRetries:
          type: integer
          default: 3
        backoffMultiplier:
          type: number
          default: 2
        initialDelay:
          type: integer
          default: 1000
        maxDelay:
          type: integer
          default: 60000

    WebhookTestResult:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
        statusCode:
          type: integer
        responseTime:
          type: integer
        response:
          type: object
        error:
          type: string

    # Utility schemas
    Pagination:
      type: object
      required:
        - page
        - limit
        - total
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    EntityMetadata:
      type: object
      properties:
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        version:
          type: integer

  parameters:
    UserIdPath:
      name: userId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    OffsetParam:
      name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
