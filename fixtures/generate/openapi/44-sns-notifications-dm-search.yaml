openapi: 3.1.0
info:
  title: Social Network API - Notifications, Messages & Discovery
  version: 1.0.0
  description: |
    Twitter/X風SNSクローンのための通知・メッセージ・検索API。
    通知、ダイレクトメッセージ、検索、トレンド、おすすめなどの機能を提供します。

servers:
  - url: https://api.social.example.com/v1
    description: Production
  - url: http://localhost:3000/v1
    description: Development

tags:
  - name: Notifications
    description: 通知
  - name: Direct Messages
    description: ダイレクトメッセージ
  - name: Search
    description: 検索
  - name: Trends
    description: トレンド
  - name: Suggestions
    description: おすすめ

paths:
  /notifications:
    get:
      tags:
        - Notifications
      operationId: listNotifications
      summary: 通知一覧取得
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: types
          in: query
          description: 通知タイプでフィルタ（カンマ区切り）
          schema:
            type: string
          example: like,repost,follow,mention
        - name: filter
          in: query
          schema:
            type: string
            enum:
              - all
              - mentions
              - verified
            default: all
      responses:
        '200':
          description: 通知一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /notifications/unread-count:
    get:
      tags:
        - Notifications
      operationId: getUnreadNotificationCount
      summary: 未読通知数取得
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 未読数
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  mentionsCount:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /notifications/mark-read:
    post:
      tags:
        - Notifications
      operationId: markNotificationsRead
      summary: 通知を既読にする
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                notificationIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: 指定しない場合は全て既読
                maxId:
                  type: string
                  description: このID以前を既読
      responses:
        '200':
          description: 成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /notifications/settings:
    get:
      tags:
        - Notifications
      operationId: getNotificationSettings
      summary: 通知設定取得
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 通知設定
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationSettings'
        '401':
          $ref: '#/components/responses/Unauthorized'
    put:
      tags:
        - Notifications
      operationId: updateNotificationSettings
      summary: 通知設定更新
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationSettings'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationSettings'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dm/conversations:
    get:
      tags:
        - Direct Messages
      operationId: listConversations
      summary: 会話一覧取得
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: 会話一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags:
        - Direct Messages
      operationId: createConversation
      summary: 会話作成
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - participantIds
              properties:
                participantIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 1
                  maxItems: 50
                  description: 参加者のユーザーID
                name:
                  type: string
                  maxLength: 50
                  description: グループ会話の名前
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dm/conversations/{conversationId}:
    parameters:
      - $ref: '#/components/parameters/ConversationIdParam'
    get:
      tags:
        - Direct Messages
      operationId: getConversation
      summary: 会話詳細取得
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 会話詳細
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags:
        - Direct Messages
      operationId: leaveConversation
      summary: 会話を退出
      security:
        - bearerAuth: []
      responses:
        '204':
          description: 退出成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dm/conversations/{conversationId}/messages:
    parameters:
      - $ref: '#/components/parameters/ConversationIdParam'
    get:
      tags:
        - Direct Messages
      operationId: listMessages
      summary: メッセージ一覧取得
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: メッセージ一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags:
        - Direct Messages
      operationId: sendMessage
      summary: メッセージ送信
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '201':
          description: 送信成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dm/conversations/{conversationId}/read:
    parameters:
      - $ref: '#/components/parameters/ConversationIdParam'
    post:
      tags:
        - Direct Messages
      operationId: markConversationRead
      summary: 会話を既読にする
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                lastReadMessageId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: 成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dm/conversations/{conversationId}/typing:
    parameters:
      - $ref: '#/components/parameters/ConversationIdParam'
    post:
      tags:
        - Direct Messages
      operationId: sendTypingIndicator
      summary: 入力中インジケーター送信
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 送信成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dm/messages/{messageId}:
    parameters:
      - name: messageId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    delete:
      tags:
        - Direct Messages
      operationId: deleteMessage
      summary: メッセージ削除
      security:
        - bearerAuth: []
      responses:
        '204':
          description: 削除成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dm/messages/{messageId}/reactions:
    parameters:
      - name: messageId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags:
        - Direct Messages
      operationId: addMessageReaction
      summary: メッセージにリアクション追加
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - emoji
              properties:
                emoji:
                  type: string
                  description: 絵文字
      responses:
        '200':
          description: 追加成功
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      tags:
        - Direct Messages
      operationId: removeMessageReaction
      summary: メッセージのリアクション削除
      security:
        - bearerAuth: []
      parameters:
        - name: emoji
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 削除成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /dm/unread-count:
    get:
      tags:
        - Direct Messages
      operationId: getUnreadMessageCount
      summary: 未読メッセージ数取得
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 未読数
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  conversationCounts:
                    type: object
                    additionalProperties:
                      type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /search/posts:
    get:
      tags:
        - Search
      operationId: searchPosts
      summary: 投稿検索
      parameters:
        - name: q
          in: query
          required: true
          description: 検索クエリ
          schema:
            type: string
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: filter
          in: query
          schema:
            type: string
            enum:
              - latest
              - top
              - photos
              - videos
            default: top
        - name: from
          in: query
          description: 特定ユーザーからの投稿
          schema:
            type: string
        - name: to
          in: query
          description: 特定ユーザーへの返信
          schema:
            type: string
        - name: since
          in: query
          description: この日時以降
          schema:
            type: string
            format: date-time
        - name: until
          in: query
          description: この日時以前
          schema:
            type: string
            format: date-time
        - name: lang
          in: query
          description: 言語フィルタ
          schema:
            type: string
      responses:
        '200':
          description: 検索結果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostSearchResponse'

  /search/users:
    get:
      tags:
        - Search
      operationId: searchUsers
      summary: ユーザー検索
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: 検索結果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSearchResponse'

  /search/hashtags:
    get:
      tags:
        - Search
      operationId: searchHashtags
      summary: ハッシュタグ検索
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: 検索結果
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Hashtag'

  /search/recent:
    get:
      tags:
        - Search
      operationId: getRecentSearches
      summary: 最近の検索履歴
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 検索履歴
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    query:
                      type: string
                    searchedAt:
                      type: string
                      format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      tags:
        - Search
      operationId: clearRecentSearches
      summary: 検索履歴クリア
      security:
        - bearerAuth: []
      responses:
        '204':
          description: クリア成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /trends:
    get:
      tags:
        - Trends
      operationId: getTrends
      summary: トレンド取得
      parameters:
        - name: woeid
          in: query
          description: 地域ID（Where On Earth ID）
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 50
      responses:
        '200':
          description: トレンド一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Trend'

  /trends/locations:
    get:
      tags:
        - Trends
      operationId: getTrendLocations
      summary: トレンド対応地域一覧
      responses:
        '200':
          description: 地域一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TrendLocation'

  /suggestions/users:
    get:
      tags:
        - Suggestions
      operationId: getSuggestedUsers
      summary: おすすめユーザー取得
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: おすすめユーザー
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserSuggestion'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /suggestions/users/{userId}/hide:
    parameters:
      - name: userId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags:
        - Suggestions
      operationId: hideSuggestedUser
      summary: おすすめユーザーを非表示
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 非表示成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /suggestions/topics:
    get:
      tags:
        - Suggestions
      operationId: getSuggestedTopics
      summary: おすすめトピック取得
      security:
        - bearerAuth: []
      responses:
        '200':
          description: おすすめトピック
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Topic'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /topics/{topicId}/follow:
    parameters:
      - name: topicId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags:
        - Suggestions
      operationId: followTopic
      summary: トピックをフォロー
      security:
        - bearerAuth: []
      responses:
        '200':
          description: フォロー成功
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      tags:
        - Suggestions
      operationId: unfollowTopic
      summary: トピックのフォロー解除
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 解除成功
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    ConversationIdParam:
      name: conversationId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    CursorParam:
      name: cursor
      in: query
      schema:
        type: string

    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    Notification:
      type: object
      required:
        - id
        - type
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum:
            - like
            - repost
            - quote
            - reply
            - mention
            - follow
            - follow_request
            - poll_ended
            - post_you_liked
            - new_posts_from
        actor:
          $ref: '#/components/schemas/UserSummary'
          description: アクションを起こしたユーザー
        actors:
          type: array
          items:
            $ref: '#/components/schemas/UserSummary'
          description: 複数ユーザーの場合（いいねなど）
        post:
          $ref: '#/components/schemas/PostSummary'
        targetPost:
          $ref: '#/components/schemas/PostSummary'
          description: 引用・返信の場合の対象投稿
        isRead:
          type: boolean
        createdAt:
          type: string
          format: date-time

    NotificationSettings:
      type: object
      properties:
        likes:
          type: boolean
        reposts:
          type: boolean
        quotes:
          type: boolean
        replies:
          type: boolean
        mentions:
          type: boolean
        follows:
          type: boolean
        directMessages:
          type: boolean
        emailNotifications:
          type: object
          properties:
            enabled:
              type: boolean
            digest:
              type: string
              enum:
                - daily
                - weekly
                - never
        pushNotifications:
          type: boolean
        filterQuality:
          type: string
          enum:
            - all
            - filtered
          description: 低品質通知のフィルタリング

    Conversation:
      type: object
      required:
        - id
        - type
        - participants
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum:
            - one_to_one
            - group
        name:
          type: string
          description: グループ会話の名前
        participants:
          type: array
          items:
            $ref: '#/components/schemas/UserSummary'
        lastMessage:
          $ref: '#/components/schemas/Message'
        unreadCount:
          type: integer
        isMuted:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Message:
      type: object
      required:
        - id
        - conversationId
        - sender
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        conversationId:
          type: string
          format: uuid
        sender:
          $ref: '#/components/schemas/UserSummary'
        text:
          type: string
          maxLength: 10000
        media:
          type: array
          items:
            $ref: '#/components/schemas/MediaAttachment'
        sharedPost:
          $ref: '#/components/schemas/PostSummary'
        reactions:
          type: array
          items:
            type: object
            properties:
              emoji:
                type: string
              users:
                type: array
                items:
                  $ref: '#/components/schemas/UserSummary'
        readBy:
          type: array
          items:
            type: string
            format: uuid
        createdAt:
          type: string
          format: date-time

    SendMessageRequest:
      type: object
      properties:
        text:
          type: string
          maxLength: 10000
        mediaIds:
          type: array
          items:
            type: string
            format: uuid
        sharedPostId:
          type: string
          format: uuid

    Hashtag:
      type: object
      required:
        - name
        - postCount
      properties:
        name:
          type: string
        postCount:
          type: integer
        trend:
          type: object
          properties:
            rank:
              type: integer
            trendingIn:
              type: string

    Trend:
      type: object
      required:
        - name
        - postCount
      properties:
        name:
          type: string
        category:
          type: string
          enum:
            - hashtag
            - topic
            - event
        postCount:
          type: integer
        description:
          type: string
        url:
          type: string
          format: uri
        promoted:
          type: boolean

    TrendLocation:
      type: object
      required:
        - woeid
        - name
        - country
      properties:
        woeid:
          type: integer
        name:
          type: string
        country:
          type: string
        countryCode:
          type: string
        parentId:
          type: integer

    UserSuggestion:
      type: object
      required:
        - user
        - reason
      properties:
        user:
          $ref: '#/components/schemas/UserSummary'
        reason:
          type: string
          enum:
            - followed_by_friends
            - similar_interests
            - popular
            - new_to_platform
        mutualFollowers:
          type: array
          items:
            $ref: '#/components/schemas/UserSummary'
        mutualFollowersCount:
          type: integer

    Topic:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        icon:
          type: string
          format: uri
        followerCount:
          type: integer
        isFollowing:
          type: boolean
        category:
          type: string

    UserSummary:
      type: object
      required:
        - id
        - username
        - displayName
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string
        displayName:
          type: string
        avatarUrl:
          type: string
          format: uri
        isVerified:
          type: boolean

    PostSummary:
      type: object
      required:
        - id
        - text
      properties:
        id:
          type: string
          format: uuid
        text:
          type: string
        author:
          $ref: '#/components/schemas/UserSummary'

    MediaAttachment:
      type: object
      required:
        - id
        - type
        - url
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum:
            - image
            - gif
            - video
        url:
          type: string
          format: uri
        previewUrl:
          type: string
          format: uri

    NotificationListResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Notification'
        nextCursor:
          type: string

    ConversationListResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Conversation'
        nextCursor:
          type: string

    MessageListResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        nextCursor:
          type: string

    PostSearchResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/PostSummary'
        nextCursor:
          type: string
        totalCount:
          type: integer

    UserSearchResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/UserSummary'
        nextCursor:
          type: string

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string

  responses:
    Unauthorized:
      description: 認証が必要です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: リソースが見つかりません
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
